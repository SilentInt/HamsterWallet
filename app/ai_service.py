# app/ai_service.py
import base64
import json
from openai import OpenAI
from flask import current_app


class AIService:
    """处理与OpenAI交互的服务"""

    def __init__(self):
        self.client = None  # 延迟初始化
        # --- 商品分类定义 ---
        self.product_categories = [
            {
                "食品": [
                    {"水果": ["苹果", "香蕉", "橙子", "葡萄", "草莓", "其他水果"]},
                    {
                        "蔬菜": [
                            "大葱",
                            "大蒜",
                            "生姜",
                            "香葱",
                            "香菜",
                            "芹菜",
                            "西兰花",
                            "菜花",
                            "茄子",
                            "南瓜",
                            "青菜",
                            "豆角",
                            "豌豆",
                            "西红柿",
                            "黄瓜",
                            "胡萝卜",
                            "土豆",
                            "洋葱",
                            "青椒",
                            "辣椒",
                            "西葫芦",
                            "萝卜",
                            "西生菜",
                            "菠菜",
                            "大头菜",
                            "小白菜",
                            "油麦菜",
                            "小松菜",
                            "紫甘蓝",
                            "油菜",
                            "生菜",
                            "白菜",
                            "玉米",
                            "笋",
                            "春菊",
                            "蟹味菇",
                            "杏鲍菇",
                            "香菇",
                            "金针菇",
                            "平菇",
                            "其他新鲜菌类",
                            "豆芽",
                            "豆苗",
                            "混合蔬菜包",
                            "其他蔬菜",
                        ]
                    },
                    {
                        "肉类": [
                            "鸡腿肉",
                            "鸡胸肉",
                            "鸡蛋",
                            "牛肉",
                            "猪肉",
                            "羊肉",
                            "火腿",
                            "香肠",
                            "鱼",
                            "虾",
                            "其他海鲜",
                            "其他肉类",
                        ]
                    },
                    {"豆制品": ["豆腐", "纳豆", "大豆", "其他豆制品"]},
                    {"主食": ["大米", "面条", "馒头", "面包", "其他主食"]},
                    {"干货": ["干果", "干菌菇", "海带", "木耳", "豆腐干", "其他干货"]},
                    {"乳制品": ["牛奶", "酸奶", "奶酪", "冰淇淋", "其他乳制品"]},
                    {
                        "调味品": [
                            "盐",
                            "食用油",
                            "糖",
                            "酱油",
                            "醋",
                            "蚝油",
                            "豆瓣酱",
                            "花椒",
                            "大料",
                            "八角",
                            "桂皮",
                            "香叶",
                            "辣椒粉",
                            "香料",
                            "咖喱",
                            "调料汁",
                            "其他调味品",
                        ]
                    },
                    {
                        "便当": [
                            "鸡肉便当",
                            "猪肉便当",
                            "三明治",
                            "牛肉便当",
                            "海鲜便当",
                            "沙拉便当",
                            "素食便当",
                            "饭团",
                            "寿司",
                            "小吃炸物",
                            "其他便当",
                        ]
                    },
                    {"外食": ["拉面", "乌冬面", "盖饭", "自助餐", "套餐", "其他外食"]},
                    {"其他": ["零食", "饮料"]},
                ]
            },
            {
                "日用品": [
                    {
                        "清洁用品": [
                            "洗洁精",
                            "洗衣液",
                            "洗衣粉",
                            "肥皂",
                            "消毒液",
                            "玻璃清洁剂",
                            "地板清洁剂",
                            "洁厕灵",
                            "去污粉",
                            "清洁刷",
                            "抹布",
                            "拖把",
                            "扫帚",
                            "垃圾袋",
                        ]
                    },
                    {"纸制品": ["卫生纸", "抽纸", "厨房纸巾", "湿巾", "手帕纸"]},
                    {
                        "厨房用品": [
                            "保鲜膜",
                            "保鲜袋",
                            "铝箔纸",
                            "烘焙纸",
                            "洗碗海绵",
                            "洗碗手套",
                        ]
                    },
                    {"卫浴用品": ["漱口水", "浴帽", "搓澡巾", "浴球"]},
                    {"卧室用品": ["衣架", "收纳箱"]},
                    {
                        "杂物": [
                            "粘钩",
                            "樟脑丸",
                            "干燥剂",
                            "杀虫剂",
                            "蚊香",
                            "电池",
                            "胶带",
                            "针线包",
                            "其他杂物",
                        ]
                    },
                ]
            },
            {
                "美妆个护": [
                    {
                        "面部护肤": [
                            "洁面乳",
                            "卸妆水/油",
                            "化妆水",
                            "精华液",
                            "乳液",
                            "面霜",
                            "眼霜",
                            "面膜",
                            "防晒霜",
                            "爽肤水",
                            "去角质",
                        ]
                    },
                    {
                        "彩妆": [
                            "隔离霜",
                            "粉底液/霜",
                            "BB霜/CC霜",
                            "气垫",
                            "散粉/蜜粉",
                            "遮瑕膏",
                            "眉笔/眉粉",
                            "眼影",
                            "眼线笔/液",
                            "睫毛膏",
                            "腮红",
                            "高光",
                            "修容",
                            "口红/唇釉",
                            "唇彩",
                            "指甲油",
                        ]
                    },
                    {
                        "身体护理": [
                            "沐浴露",
                            "身体乳",
                            "护手霜",
                            "足部护理",
                            "香皂",
                            "磨砂膏",
                            "精油",
                        ]
                    },
                    {"头发护理": ["洗发水", "护发素", "护发精油"]},
                    {"口腔护理": ["牙膏", "牙刷", "漱口水", "牙线"]},
                    {
                        "个人护理": [
                            "卫生巾",
                            "护垫",
                            "棉条",
                            "剃须刀",
                            "脱毛膏/蜡纸",
                            "洗手液",
                            "香水",
                            "止汗露",
                        ]
                    },
                    {
                        "美容工具": [
                            "化妆棉",
                            "粉扑",
                            "化妆刷",
                            "睫毛夹",
                            "修眉刀",
                            "洁面仪",
                            "卷发棒",
                            "直发器",
                        ]
                    },
                ]
            },
            {
                "家居家装": [
                    {
                        "家纺": [
                            "床品套件",
                            "被子",
                            "枕头",
                            "床垫",
                            "毛巾",
                            "浴巾",
                            "地毯",
                            "地垫",
                            "窗帘",
                            "沙发垫",
                            "桌布",
                        ]
                    },
                    {"家具": ["床", "桌子", "储物柜"]},
                    {
                        "家饰": [
                            "装饰画",
                            "花瓶",
                            "摆件",
                            "相框",
                            "墙贴",
                            "香薰",
                            "蜡烛",
                            "仿真花",
                        ]
                    },
                    {
                        "厨具": [
                            "锅具",
                            "刀具",
                            "砧板",
                            "餐具",
                            "碗",
                            "盘",
                            "筷子",
                            "勺子",
                            "水杯",
                            "保温杯",
                            "厨房置物架",
                            "烘焙用具",
                        ]
                    },
                    {"灯具": ["台灯"]},
                    {
                        "五金工具": [
                            "螺丝刀",
                            "扳手",
                            "卷尺",
                            "钳子",
                            "锁具",
                            "钉子螺丝",
                        ]
                    },
                ]
            },
            {
                "电器数码": [
                    {"厨房电器": ["电饭煲", "微波炉", "烤箱", "电磁炉", "电水壶"]},
                    {
                        "生活电器": [
                            "吸尘器",
                            "扫地机器人",
                            "电风扇",
                            "取暖器",
                            "加湿器",
                            "空气净化器",
                        ]
                    },
                    {"个人护理电器": ["吹风机", "电动牙刷", "剃须刀", "卷/直发器"]},
                    {
                        "数码配件": [
                            "移动硬盘",
                            "U盘",
                            "手机壳",
                            "手机贴膜",
                            "充电器",
                            "数据线",
                            "充电宝",
                            "耳机",
                            "音箱",
                            "存储卡",
                            "读卡器",
                        ]
                    },
                    {
                        "摄影摄像": [
                            "数码相机",
                            "单反相机",
                            "微单相机",
                            "摄像机",
                            "镜头",
                            "三脚架",
                            "相机包",
                        ]
                    },
                ]
            },
            {
                "服装鞋帽": [
                    {
                        "女装": [
                            "连衣裙",
                            "T恤",
                            "衬衫",
                            "针织衫",
                            "卫衣",
                            "毛衣",
                            "外套",
                            "西装",
                            "风衣",
                            "大衣",
                            "羽绒服",
                            "裤子",
                            "半身裙",
                            "套装",
                        ]
                    },
                    {
                        "内衣": [
                            "文胸",
                            "内裤",
                            "睡衣",
                            "家居服",
                            "塑身衣",
                            "保暖内衣",
                            "袜子",
                        ]
                    },
                    {
                        "鞋类": [
                            "运动鞋",
                            "休闲鞋",
                            "皮鞋",
                            "帆布鞋",
                            "板鞋",
                            "靴子",
                            "凉鞋",
                            "拖鞋",
                            "高跟鞋",
                            "童鞋",
                        ]
                    },
                    {
                        "配饰": [
                            "帽子",
                            "围巾",
                            "手套",
                            "皮带",
                            "领带",
                            "领结",
                            "袖扣",
                            "发饰",
                            "太阳镜",
                            "眼镜框",
                            "饰品",
                            "胸针",
                        ]
                    },
                    {
                        "箱包": [
                            "双肩包",
                            "单肩包",
                            "手提包",
                            "斜挎包",
                            "钱包",
                            "卡包",
                            "拉杆箱",
                            "旅行包",
                            "电脑包",
                            "化妆包",
                        ]
                    },
                ]
            },
            {
                "医疗保健": [
                    {
                        "常用药品": [
                            "感冒发烧",
                            "咳嗽化痰",
                            "肠胃用药",
                            "止痛镇痛",
                            "过敏用药",
                            "眼耳鼻喉",
                            "皮肤用药",
                            "跌打损伤",
                            "晕车晕船",
                        ]
                    },
                    {"中成药": ["汉方药", "中药饮片"]},
                    {"医疗器械": ["体温计"]},
                    {
                        "保健品": [
                            "维生素",
                            "矿物质",
                            "蛋白粉",
                            "鱼油",
                            "益生菌",
                            "膳食纤维",
                            "滋补品",
                            "功能性保健品",
                        ]
                    },
                    {
                        "护理护具": [
                            "创可贴",
                            "纱布",
                            "绷带",
                            "棉签",
                            "酒精",
                            "碘伏",
                            "口罩",
                            "手套",
                            "护腰",
                            "护膝",
                            "护腕",
                            "冷热敷贴",
                        ]
                    },
                    {"健康服务": ["体检套餐"]},
                ]
            },
            {
                "办公文具": [
                    {
                        "书写工具": [
                            "中性笔",
                            "自动铅笔",
                            "自动铅笔铅",
                            "荧光笔",
                            "毛笔",
                            "笔芯",
                            "墨水",
                        ]
                    },
                    {
                        "纸张本册": [
                            "打印纸",
                            "活页纸",
                            "活页纸夹",
                            "笔记本",
                            "便利贴",
                            "信纸",
                            "信封",
                        ]
                    },
                    {
                        "办公文具": [
                            "订书机",
                            "打孔器",
                            "剪刀",
                            "美工刀",
                            "胶水",
                            "胶带",
                            "回形针",
                            "图钉",
                            "长尾夹",
                            "文件夹",
                            "计算器",
                            "尺子",
                            "橡皮",
                            "文件袋",
                            "印章",
                            "印泥",
                        ]
                    },
                ]
            },
            {"图书": [{"图书": ["图书"]}]},
            {
                "杂费支出": [
                    {"通讯": ["电话费", "宽带费", "其他通讯"]},
                    {"交通": ["公交", "地铁", "打车", "共享单车", "其他交通"]},
                    {"其他": ["其他"]},
                ]
            },
        ]

    def _get_client(self):
        """获取OpenAI客户端，延迟初始化"""
        if self.client is None:
            api_key = current_app.config.get("OPENAI_API_KEY")
            if not api_key:
                raise ValueError("OPENAI_API_KEY not configured")
            base_url = current_app.config.get(
                "OPENAI_API_BASE_URL", "https://x666.me/v1"
            )
            self.client = OpenAI(base_url=base_url, api_key=api_key)
            self.model_name = current_app.config.get("MODULE_NAME", "gemini-2.5-pro")
        return self.client

    def _encode_image(self, image_path):
        """将图片文件编码为base64字符串"""
        with open(image_path, "rb") as image_file:
            return base64.b64encode(image_file.read()).decode("utf-8")

    def _build_prompt(self):
        """构建AI识别的提示词"""
        return f"""
# 角色
你是一个专业的数据处理助手，擅长从图片中提取信息并将其结构化。

# 任务
分析提供的日本购物小票图片，提取关键信息，并按照指定的JSON格式和内容要求进行处理和输出。处理过程中，商品分类的选择必须严格遵循提供的商品分类定义表。

# 输入
一张日本购物小票的图片。

# 输出要求
**严格按照以下要求输出一个单独的JSON对象。不要包含任何markdown代码块（例如 ```json ... ```）或其他任何解释性文字或注释。**

# JSON结构和字段处理详细说明

## 顶层字段:
1.  **`store_name`** (string):
    *   准确提取小票上打印的店铺完整名称。
2.  **`store_category`** (string):
    *   根据店铺名称和售卖商品，判断店铺的主要分类。
    *   从以下列表中选择最匹配的一项：["便利店", "药妆店", "商超", "家具店", "电器店", "百货商店", "餐饮店", "专卖店", "其他"] (如果都不严格匹配但接近某一类，请选择最接近的；如果完全不匹配，请选择"其他")。
3.  **`notes`** (string):
    *   仔细查找小票上可能存在的任何备注信息（打印或手写）。
    *   如果找到，提取原文并将其翻译成**中文**。
    *   如果没有备注信息，则此字段值应为空字符串 `""`。
4.  **`name`** (string):
    *   根据小票内容生成一个简洁明了、方便用户识别的小票名称。
    *   **格式严格遵循**: "YYYY-MM-DD_购物目的简述_店铺名简写"
    *   **日期**: 使用小票上的购买日期。
    *   **购物目的简述**: 基于购买的主要商品类型或购物行为进行概括，例如 "采购食材", "购买药品", "日常用品补货", "购买电器"。
    *   **店铺名简写**: 使用店铺名称的关键部分或易于识别的缩写。
    *   **示例**: "2025-04-08_采购菜品_吴服町"
5.  **`transaction_time`** (string):
    *   提取小票上的购买日期和时间。
    *   **格式严格遵循**: "YYYY-MM-DD HH:MM:SS" (24小时制)。
6.  **`items`** (array):
    *   一个包含小票上所有购买商品的数组，数组中的每个元素都是一个代表单个商品的JSON对象。
    *   详细信息见下一节。

## `items` 数组内对象字段:
对于 `items` 数组中的每一个商品对象，包含以下字段：

1.  **`name_ja`** (string):
    *   准确提取商品在小票上显示的日文名称，包括括号内的规格、重量等信息（如果存在）。
2.  **`name_zh`** (string):
    *   基于 `name_ja`、`store_category` 等上下文信息，推断或翻译成**符合中文习惯的、具体的商品名称**。
    *   **重点**: 只标注商品是什么，**省略品牌信息**，但**保留必要的规格、数量或重量信息** (例如 "香蕉(500g)", "牛奶(1L)", "牙膏")。
    *   力求准确、自然。
3.  **`category_1`** (string):
    *   **必须**从文末提供的 **商品分类定义表** 中的一级分类中选择**最匹配**的一项。
4.  **`category_2`** (string):
    *   基于选择的 `category_1`，从 **商品分类定义表** 中对应 `category_1` 下的二级分类中选择**最匹配**的一项。
5.  **`category_3`** (string):
    *   基于选择的 `category_2`，从 **商品分类定义表** 中对应 `category_2` 下的三级分类中选择**最匹配**的一项。
    *   **此字段的值必须严格来自于商品分类定义表中列出的三级分类名称。不允许生成列表中未包含的词语。**
6.  **`price_jpy`** (number or string):
    *   计算并提取该商品（考虑数量）的**最终含税日元价格**。
    *   **注意**: 仔细判断小票上的价格是**税抜 (税前)** 还是 **税込 (税后)**，并正确计算包含消费税的总价。如果小票列出了多个相同商品，确保计算的是**总价**。
    *   输出为数值或字符串格式皆可 (例如 438 或 "438")。
7.  **`price_cny`** (number or string):
    *   根据**当前大致汇率** (如果无法获取实时汇率，可基于近期汇率估算或由用户后续处理)，将 `price_jpy` 换算成人民币价格。
    *   结果保留两位小数。
    *   输出为数值或字符串格式皆可 (例如 21.90 或 "21.90")。如果无法估算，可留空或填0。
8.  **`special_info`** (string):
    *   判断该商品是否为特价商品。
    *   检查商品行是否包含 "特売", "特価", "割引", "値引" 等明确表示折扣的字样，或者价格旁边有折扣标记。
    *   如果识别到具体的折扣比例 (例如 `20%引き`)，则填入折扣信息，格式为 **"-20%"**。
    *   如果仅能判断是特价但无法识别具体比例，则填 **"是"**。
    *   如果没有任何特价标识，则填 **"否"**。

# 商品分类定义表
**请严格按照此表选择 `category_1`, `category_2`, 和 `category_3`。**

{str(self.product_categories)}
"""

    def recognize_receipt(self, text_description=None, image_path=None):
        """识别小票内容

        Args:
            text_description: 文字描述
            image_path: 图片路径

        Returns:
            dict: AI识别结果，失败时返回None
        """
        if not image_path and not text_description:
            raise ValueError("必须提供图片或文本描述")

        prompt = self._build_prompt()

        try:
            client = self._get_client()

            if image_path:
                base64_image = self._encode_image(image_path)
                messages = [
                    {
                        "role": "system",
                        "content": [{"type": "text", "text": prompt}],
                    },
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{base64_image}"
                                },
                            },
                            {"type": "text", "text": text_description or ""},
                        ],
                    },
                ]
            else:
                messages = [
                    {"role": "system", "content": prompt},
                    {"role": "user", "content": text_description},
                ]

            response = client.chat.completions.create(
                model=self.model_name,
                messages=messages,  # type: ignore
            )

            response_content = response.choices[0].message.content
            if response_content is None:
                current_app.logger.error("OpenAI API returned empty response")
                return None

            # 清理和解析JSON
            json_str = response_content.strip().lstrip("```json").rstrip("```")
            return json.loads(json_str)

        except Exception as e:
            current_app.logger.error(f"OpenAI API call failed: {e}")
            return None
