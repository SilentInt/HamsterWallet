{% extends "base.html" %}

{% block title %}分类管理 - 仓鼠记账{% endblock %}

{% block extra_css %}
<style>
    .category-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 24px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        border: 1px solid #f0f0f0;
    }

    .category-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f8f9fa;
    }

    .category-title {
        display: flex;
        align-items: center;
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .category-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1.5rem;
        color: white;
    }

    .level-1-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .level-2-icon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .level-3-icon {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .category-actions {
        display: flex;
        gap: 8px;
    }

    .btn-action {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-edit {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .btn-edit:hover {
        background: linear-gradient(135deg, #3d9aec 0%, #00e0ec 100%);
        transform: translateY(-1px);
    }

    .btn-add {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #2c3e50;
    }

    .btn-add:hover {
        background: linear-gradient(135deg, #96e5e1 0%, #fcc4d1 100%);
        transform: translateY(-1px);
    }

    .btn-merge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-merge:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
        color: white;
    }

    .btn-delete {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }

    .btn-delete:hover {
        background: linear-gradient(135deg, #f95d88 0%, #fdd52e 100%);
        transform: translateY(-1px);
    }

    .subcategory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .subcategory-item {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
    }

    .subcategory-item:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        border-color: #dee2e6;
        transform: translateY(-2px);
    }

    .subcategory-header {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 12px;
    }

    .subcategory-name {
        font-weight: 600;
        color: #495057;
        flex-grow: 1;
    }

    .subcategory-actions {
        display: flex;
        gap: 6px;
    }

    .sub-subcategory-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .sub-subcategory-tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .stats-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 20px;
        text-align: center;
    }

    .stats-item {
        padding: 12px;
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 8px;
        display: block;
    }

    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f8f9fa;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }

    .btn-create-main {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .btn-create-main:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 16px;
        margin: 40px 0;
    }

    .empty-state i {
        font-size: 5rem;
        margin-bottom: 24px;
        opacity: 0.5;
        color: #667eea;
    }

    .empty-state h4 {
        margin-bottom: 16px;
        color: #495057;
    }

    .btn-sm-custom {
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 6px;
    }

    /* 级联选择器样式 */
    .category-select-group {
        position: relative;
    }

    .category-select-group .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
    }

    .category-select-group .form-select {
        border: 1.5px solid #e9ecef;
        border-radius: 8px;
        padding: 8px 12px;
        transition: all 0.2s ease;
        background-color: #fff;
    }

    .category-select-group .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        background-color: #fff;
    }

    .category-select-group .form-select:disabled {
        background-color: #f8f9fa;
        border-color: #e9ecef;
        color: #6c757d;
    }

    .cascade-selectors .col-md-6 {
        padding-left: 8px;
        padding-right: 8px;
    }

    .cascade-selectors .col-md-6:first-child {
        padding-left: 15px;
    }

    .cascade-selectors .col-md-6:last-child {
        padding-right: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-tags"></i> 分类管理
    </h1>
    <div class="dropdown">
        <button class="btn btn-create-main dropdown-toggle" type="button" id="createDropdown" data-bs-toggle="dropdown">
            <i class="fas fa-plus"></i> 创建分类
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="openCreateModal(1)">
                    <i class="fas fa-plus-circle text-primary"></i> 创建一级分类
                </a></li>
            {% if category_tree %}
            <li><a class="dropdown-item" href="#" onclick="openCreateModal(2)">
                    <i class="fas fa-plus-circle text-info"></i> 创建二级分类
                </a></li>
            <li><a class="dropdown-item" href="#" onclick="openCreateModal(3)">
                    <i class="fas fa-plus-circle text-success"></i> 创建三级分类
                </a></li>
            {% endif %}
        </ul>
    </div>
</div>

<!-- 统计信息 -->
<div class="stats-section">
    <div class="stats-grid">
        <div class="stats-item">
            <span class="stats-number">{{ stats.level1_count or 0 }}</span>
            <div class="stats-label">一级分类</div>
        </div>
        <div class="stats-item">
            <span class="stats-number">{{ stats.level2_count or 0 }}</span>
            <div class="stats-label">二级分类</div>
        </div>
        <div class="stats-item">
            <span class="stats-number">{{ stats.level3_count or 0 }}</span>
            <div class="stats-label">三级分类</div>
        </div>
        <div class="stats-item">
            <span class="stats-number">{{ stats.total_count or 0 }}</span>
            <div class="stats-label">总计</div>
        </div>
    </div>
</div>

<!-- 分类内容 -->
{% if category_tree %}
{% for category1 in category_tree %}
<div class="category-card">
    <div class="category-header">
        <div class="category-title">
            <div class="category-icon level-1-icon">
                <i class="fas fa-folder"></i>
            </div>
            {{ category1.name }}
        </div>
        <div class="category-actions">
            <button class="btn btn-action btn-edit" data-category-id="{{ category1.id }}"
                data-category-name="{{ category1.name }}" data-category-level="{{ category1.level }}"
                data-category-parent="{{ category1.parent_id or '' }}" onclick="editCategory(this)" title="编辑分类">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-action btn-add" onclick="openCreateModal(2, {{ category1.id }})" title="添加子分类">
                <i class="fas fa-plus"></i>
            </button>
            <button class="btn btn-action btn-merge"
                onclick="showMergeModal({{ category1.id }}, '{{ category1.name }}', {{ category1.level }})"
                title="合并分类">
                <i class="fas fa-exchange-alt"></i>
            </button>
            <button class="btn btn-action btn-delete"
                onclick="deleteCategory({{ category1.id }}, '{{ category1.name }}')" title="删除分类">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>

    {% if category1.children %}
    <div class="subcategory-grid">
        {% for category2 in category1.children %}
        <div class="subcategory-item">
            <div class="subcategory-header">
                <div class="subcategory-name">
                    <i class="fas fa-folder-open text-info"></i> {{ category2.name }}
                </div>
                <div class="subcategory-actions">
                    <button class="btn btn-action btn-edit btn-sm-custom" data-category-id="{{ category2.id }}"
                        data-category-name="{{ category2.name }}" data-category-level="{{ category2.level }}"
                        data-category-parent="{{ category2.parent_id or '' }}" onclick="editCategory(this)" title="编辑">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-action btn-add btn-sm-custom"
                        onclick="openCreateModal(3, {{ category2.id }})" title="添加子分类">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-action btn-merge btn-sm-custom"
                        onclick="showMergeModal({{ category2.id }}, '{{ category2.name }}', {{ category2.level }})"
                        title="合并分类">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="btn btn-action btn-delete btn-sm-custom"
                        onclick="deleteCategory({{ category2.id }}, '{{ category2.name }}')" title="删除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            {% if category2.children %}
            <div class="sub-subcategory-list">
                {% for category3 in category2.children %}
                <div class="sub-subcategory-tag">
                    <i class="fas fa-tag"></i>
                    {{ category3.name }}
                    <button class="btn btn-sm p-0 ms-1 text-white" data-category-id="{{ category3.id }}"
                        data-category-name="{{ category3.name }}" data-category-level="{{ category3.level }}"
                        data-category-parent="{{ category3.parent_id or '' }}" onclick="editCategory(this)" title="编辑"
                        style="background: none; border: none; font-size: 0.7rem;">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm p-0 ms-1 text-white"
                        onclick="showMergeModal({{ category3.id }}, '{{ category3.name }}', {{ category3.level }})"
                        title="合并分类" style="background: none; border: none; font-size: 0.7rem;">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="btn btn-sm p-0 ms-1 text-white"
                        onclick="deleteCategory({{ category3.id }}, '{{ category3.name }}')" title="删除"
                        style="background: none; border: none; font-size: 0.7rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted small">
                <i class="fas fa-info-circle"></i> 暂无三级分类
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-muted text-center py-3">
        <i class="fas fa-folder-plus"></i> 暂无二级分类，点击上方"+"按钮添加
    </div>
    {% endif %}
</div>
{% endfor %}
{% else %}
<div class="empty-state">
    <i class="fas fa-folder-open"></i>
    <h4>暂无分类</h4>
    <p class="mb-4">点击上方"创建分类"按钮开始创建您的第一个分类</p>
    <button class="btn btn-create-main" onclick="openCreateModal(1)">
        <i class="fas fa-plus"></i> 创建一级分类
    </button>
</div>
{% endif %}

<!-- 创建分类模态框 -->
<div class="modal fade" id="createCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalTitle">创建分类</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createCategoryForm">
                <div class="modal-body">
                    <input type="hidden" id="createCategoryLevel">
                    <input type="hidden" id="createParentId">
                    <div class="mb-3">
                        <label for="createCategoryName" class="form-label">分类名称</label>
                        <input type="text" class="form-control" id="createCategoryName" required>
                    </div>
                    <div class="mb-3" id="createParentCategoryGroup" style="display: none;">
                        <label class="form-label">父分类选择</label>
                        <div class="row cascade-selectors" id="createCascadeSelectors">
                            <div class="col-md-6" id="createLevel1Group" style="display: none;">
                                <div class="mb-3 category-select-group">
                                    <label class="form-label">
                                        <i class="fas fa-tags me-1"></i>一级分类
                                    </label>
                                    <select class="form-select" id="createParentLevel1">
                                        <option value="">请选择一级分类</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6" id="createLevel2Group" style="display: none;">
                                <div class="mb-3 category-select-group">
                                    <label class="form-label">二级分类</label>
                                    <select class="form-select" id="createParentLevel2" disabled>
                                        <option value="">请选择二级分类</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="createParentCategoryId" />
                    </div>
                    <div class="mb-3" id="createParentInfo" style="display: none;">
                        <label class="form-label">父分类</label>
                        <div id="createParentName" class="form-control-plaintext bg-light p-2 rounded"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">创建分类</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑分类模态框 -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑分类</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCategoryForm">
                <div class="modal-body">
                    <input type="hidden" id="editCategoryId">
                    <input type="hidden" id="editCategoryLevel">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">分类名称</label>
                        <input type="text" class="form-control" id="editCategoryName" required>
                    </div>
                    <div class="mb-3" id="editParentCategoryGroup" style="display: none;">
                        <label class="form-label">父分类选择</label>
                        <div class="row cascade-selectors" id="editCascadeSelectors">
                            <div class="col-md-6" id="editLevel1Group" style="display: none;">
                                <div class="mb-3 category-select-group">
                                    <label class="form-label">
                                        <i class="fas fa-tags me-1"></i>一级分类
                                    </label>
                                    <select class="form-select" id="editParentLevel1">
                                        <option value="">请选择一级分类</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6" id="editLevel2Group" style="display: none;">
                                <div class="mb-3 category-select-group">
                                    <label class="form-label">二级分类</label>
                                    <select class="form-select" id="editParentLevel2" disabled>
                                        <option value="">请选择二级分类</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="editParentCategoryId" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除分类 "<span id="deleteCategoryName"></span>" 吗？</p>

                <!-- 分类使用信息 -->
                <div id="categoryUsageInfo" class="alert alert-info" style="display: none;">
                    <h6><i class="fas fa-info-circle"></i> 分类使用情况</h6>
                    <ul class="mb-0">
                        <li>直接关联商品：<span id="directItemsCount">0</span> 个</li>
                        <li>子分类数量：<span id="childrenCount">0</span> 个</li>
                        <li>后代分类数量：<span id="descendantCount">0</span> 个</li>
                        <li>后代分类关联商品：<span id="descendantItemsCount">0</span> 个</li>
                        <li><strong>总计关联商品：<span id="totalItemsCount">0</span> 个</strong></li>
                    </ul>
                </div>

                <!-- 警告信息 -->
                <div id="deleteWarningMessage" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="deleteWarningText"></span>
                </div>

                <!-- 商品引用警告 -->
                <div id="itemsWarningMessage" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-ban"></i>
                    <span id="itemsWarningText"></span>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showMergeOption()">
                            <i class="fas fa-exchange-alt"></i> 合并到其他分类
                        </button>
                    </div>
                </div>

                <!-- 级联删除选项 -->
                <div id="deleteCascadeOption" style="display: none;">
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="cascadeDelete">
                        <label class="form-check-label" for="cascadeDelete">
                            <strong>级联删除所有子分类</strong>
                            <div class="text-muted small">选中此选项将同时删除该分类下的所有子分类</div>
                        </label>
                    </div>
                </div>

                <p class="text-muted mt-2">此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn"
                    onclick="confirmDelete()">确定删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 分类合并模态框 -->
<div class="modal fade" id="mergeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">合并分类</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>将分类 "<span id="sourceCategoryName"></span>" 合并到其他分类：</p>

                <div class="mb-3">
                    <label for="targetCategorySelect" class="form-label">选择目标分类</label>
                    <select class="form-select" id="targetCategorySelect">
                        <option value="">请选择目标分类</option>
                    </select>
                    <div class="form-text">所有商品和子分类将被迁移到目标分类</div>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="deleteSourceAfterMerge" checked>
                    <label class="form-check-label" for="deleteSourceAfterMerge">
                        合并后删除源分类
                    </label>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    合并操作将：
                    <ul class="mb-0 mt-2">
                        <li>将所有商品的分类更改为目标分类</li>
                        <li>将所有子分类的父分类更改为目标分类</li>
                        <li>可选择是否删除源分类</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmMerge()">确定合并</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let deleteTargetId = null;
    let categoryTreeData = null; // 缓存分类树数据

    // 加载分类树数据
    async function loadCategoryTreeData() {
        if (categoryTreeData) {
            return categoryTreeData;
        }

        try {
            const response = await fetch('/api/category/tree');
            const result = await response.json();
            if (result.success) {
                categoryTreeData = result.data || [];
            } else {
                throw new Error(result.message || '获取分类数据失败');
            }
        } catch (error) {
            console.error('加载分类树数据失败:', error);
            categoryTreeData = [];
        }

        return categoryTreeData;
    }

    // 生成一级分类选项
    function generateLevel1Options(treeData) {
        if (!treeData || treeData.length === 0) {
            return '';
        }

        let options = '';
        treeData.forEach(category => {
            options += `<option value="${category.id}">${category.name}</option>`;
        });
        return options;
    }

    // 生成二级分类选项
    function generateLevel2Options(treeData, level1Id) {
        if (!treeData || !level1Id) return '';

        const level1Category = treeData.find(cat => cat.id == level1Id);
        if (!level1Category || !level1Category.children) return '';

        let options = '';
        level1Category.children.forEach(category => {
            options += `<option value="${category.id}">${category.name}</option>`;
        });
        return options;
    }

    // 设置级联选择器事件监听器
    function setupCascadeListeners(prefix, targetLevel = null) {
        console.log(`开始设置级联选择器监听器，前缀: ${prefix}, 目标级别: ${targetLevel}`);

        const level1Select = document.getElementById(`${prefix}Level1`);
        const level2Select = document.getElementById(`${prefix}Level2`);
        const parentIdInput = document.getElementById(`${prefix}CategoryId`);

        console.log(`查找元素:`, {
            level1Select: level1Select ? '找到' : '未找到',
            level2Select: level2Select ? '找到' : '未找到',
            parentIdInput: parentIdInput ? '找到' : '未找到',
            level1Id: `${prefix}Level1`,
            level2Id: `${prefix}Level2`,
            parentInputId: `${prefix}CategoryId`
        });

        if (!level1Select || !level2Select || !parentIdInput) {
            console.error(`级联选择器元素未找到: ${prefix}Level1, ${prefix}Level2, ${prefix}CategoryId`);
            return;
        }

        // 移除已存在的事件监听器（防止重复添加）
        if (level1Select._cascadeHandler) {
            level1Select.removeEventListener('change', level1Select._cascadeHandler);
        }
        if (level2Select._cascadeHandler) {
            level2Select.removeEventListener('change', level2Select._cascadeHandler);
        }

        // 一级分类变化监听器
        const level1ChangeHandler = async (e) => {
            const level1Id = e.target.value;

            console.log(`一级分类选择: ${level1Id}, 目标创建级别: ${targetLevel}`);

            // 重置二级分类
            level2Select.innerHTML = '<option value="">请选择二级分类</option>';
            level2Select.disabled = true;

            if (level1Id) {
                const treeData = await loadCategoryTreeData();
                const level2Options = generateLevel2Options(treeData, level1Id);

                if (level2Options) {
                    level2Select.innerHTML = '<option value="">请选择二级分类</option>' + level2Options;
                    level2Select.disabled = false;
                    console.log(`已加载二级分类选项`);
                }

                // 根据目标创建级别决定逻辑
                if (targetLevel === 2) {
                    // 创建二级分类：直接设置一级分类为父分类
                    parentIdInput.value = level1Id;
                    console.log(`创建二级分类：设置父分类ID为一级分类: ${level1Id}`);
                } else if (targetLevel === 3) {
                    // 创建三级分类：需要选择二级分类
                    const level1Category = treeData.find(cat => cat.id == level1Id);
                    if (!level1Category.children || level1Category.children.length === 0) {
                        // 如果一级分类没有子分类，直接设置为父分类
                        parentIdInput.value = level1Id;
                        console.log(`一级分类无子分类，设置父分类ID为一级分类: ${level1Id}`);
                    } else {
                        // 等待选择二级分类
                        parentIdInput.value = '';
                        console.log(`一级分类有子分类，等待选择二级分类`);
                    }
                } else {
                    // 编辑模式：按原逻辑处理
                    const level1Category = treeData.find(cat => cat.id == level1Id);
                    if (!level1Category.children || level1Category.children.length === 0) {
                        parentIdInput.value = level1Id;
                        console.log(`设置父分类ID为一级分类: ${level1Id}`);
                    } else {
                        parentIdInput.value = '';
                        console.log(`一级分类有子分类，等待选择二级分类`);
                    }
                }
            } else {
                parentIdInput.value = '';
                console.log(`清空父分类ID`);
            }

            console.log(`当前隐藏字段值: ${parentIdInput.value}`);
        };

        level1Select.addEventListener('change', level1ChangeHandler);

        // 二级分类变化监听器
        const level2ChangeHandler = (e) => {
            const level2Id = e.target.value;
            const level1Id = level1Select.value;

            console.log(`二级分类选择: ${level2Id}, 一级分类: ${level1Id}`);

            if (level2Id) {
                parentIdInput.value = level2Id;
                console.log(`设置父分类ID为二级分类: ${level2Id}`);
            } else {
                // 如果清空二级分类选择
                if (targetLevel === 2) {
                    // 创建二级分类时，回退到一级分类
                    parentIdInput.value = level1Id || '';
                    console.log(`创建二级分类：回退到一级分类: ${level1Id}`);
                } else {
                    parentIdInput.value = level1Id || '';
                    console.log(`设置父分类ID为一级分类: ${level1Id}`);
                }
            }

            console.log(`当前隐藏字段值: ${parentIdInput.value}`);
        };

        level2Select.addEventListener('change', level2ChangeHandler);

        // 保存事件处理器引用以便后续清理
        level1Select._cascadeHandler = level1ChangeHandler;
        level2Select._cascadeHandler = level2ChangeHandler;

        console.log(`级联选择器监听器设置完成`);
    }

    // 根据parent_id设置级联选择器的值
    async function setCascadeFromParentId(prefix, parentId) {
        if (!parentId) return;

        const treeData = await loadCategoryTreeData();
        const level1Select = document.getElementById(`${prefix}Level1`);
        const level2Select = document.getElementById(`${prefix}Level2`);

        // 查找parent分类在树中的位置
        let targetCategory = null;
        let level1Category = null;

        // 遍历查找目标分类
        for (const cat1 of treeData) {
            if (cat1.id == parentId) {
                targetCategory = cat1;
                level1Category = cat1;
                break;
            }
            if (cat1.children) {
                for (const cat2 of cat1.children) {
                    if (cat2.id == parentId) {
                        targetCategory = cat2;
                        level1Category = cat1;
                        break;
                    }
                }
                if (targetCategory) break;
            }
        }

        if (targetCategory && level1Category) {
            // 设置一级分类
            level1Select.value = level1Category.id;
            level1Select.dispatchEvent(new Event('change'));

            // 如果目标是二级分类，需要设置二级分类
            if (targetCategory.id != level1Category.id) {
                setTimeout(() => {
                    level2Select.value = targetCategory.id;
                    level2Select.dispatchEvent(new Event('change'));
                }, 100);
            }
        }
    }

    // 打开创建分类模态框
    async function openCreateModal(level, parentId = null) {
        console.log(`打开创建分类模态框: level=${level}, parentId=${parentId}`);

        const modal = document.getElementById('createCategoryModal');
        const title = document.getElementById('createModalTitle');
        const levelInput = document.getElementById('createCategoryLevel');
        const parentIdInput = document.getElementById('createParentId');
        const parentGroup = document.getElementById('createParentCategoryGroup');
        const parentInfo = document.getElementById('createParentInfo');
        const nameInput = document.getElementById('createCategoryName');

        const level1Group = document.getElementById('createLevel1Group');
        const level2Group = document.getElementById('createLevel2Group');
        const level1Select = document.getElementById('createParentLevel1');
        const level2Select = document.getElementById('createParentLevel2');
        const parentCategoryIdInput = document.getElementById('createParentCategoryId');

        console.log(`模态框元素检查:`, {
            modal: modal ? '找到' : '未找到',
            level1Group: level1Group ? '找到' : '未找到',
            level2Group: level2Group ? '找到' : '未找到',
            level1Select: level1Select ? '找到' : '未找到',
            level2Select: level2Select ? '找到' : '未找到',
            parentCategoryIdInput: parentCategoryIdInput ? '找到' : '未找到'
        });

        // 重置表单
        nameInput.value = '';
        levelInput.value = level;
        parentIdInput.value = parentId || '';
        parentCategoryIdInput.value = '';

        // 设置标题
        const levelNames = { 1: '一级', 2: '二级', 3: '三级' };
        title.textContent = `创建${levelNames[level]}分类`;

        if (level === 1) {
            // 一级分类，隐藏父分类选择
            parentGroup.style.display = 'none';
            parentInfo.style.display = 'none';
            console.log(`一级分类，隐藏父分类选择`);
        } else if (parentId) {
            // 有指定父分类，显示父分类信息
            parentGroup.style.display = 'none';
            parentInfo.style.display = 'block';

            // 获取父分类名称
            findCategoryName(parentId).then(name => {
                document.getElementById('createParentName').textContent = name;
            });

            parentCategoryIdInput.value = parentId;
            console.log(`指定父分类: ${parentId}`);
        } else {
            // 需要选择父分类 - 使用级联选择器
            parentGroup.style.display = 'block';
            parentInfo.style.display = 'none';

            // 加载分类树数据
            const treeData = await loadCategoryTreeData();
            console.log(`加载到的分类树数据:`, treeData.length);

            // 根据创建的级别显示对应的选择器
            if (level === 2) {
                // 创建二级分类，只显示一级分类选择
                level1Group.style.display = 'block';
                level2Group.style.display = 'none';

                level1Select.innerHTML = '<option value="">请选择一级分类</option>' + generateLevel1Options(treeData);
                level2Select.innerHTML = '<option value="">请选择二级分类</option>';
                level2Select.disabled = true;

                // 清空隐藏字段
                parentCategoryIdInput.value = '';

                console.log(`设置二级分类创建界面，一级分类选项数量: ${level1Select.options.length - 1}`);

                // 延迟设置事件监听器，确保DOM已完全加载
                setTimeout(() => {
                    console.log('设置二级分类创建的级联监听器');
                    setupCascadeListeners('createParent', 2);
                }, 100);
            } else if (level === 3) {
                // 创建三级分类，显示一级和二级分类选择
                level1Group.style.display = 'block';
                level2Group.style.display = 'block';

                level1Select.innerHTML = '<option value="">请选择一级分类</option>' + generateLevel1Options(treeData);
                level2Select.innerHTML = '<option value="">请选择二级分类</option>';
                level2Select.disabled = true;

                // 清空隐藏字段
                parentCategoryIdInput.value = '';

                console.log(`设置三级分类创建界面，一级分类选项数量: ${level1Select.options.length - 1}`);

                // 延迟设置事件监听器，确保DOM已完全加载
                setTimeout(() => {
                    console.log('设置三级分类创建的级联监听器');
                    setupCascadeListeners('createParent', 3);
                }, 100);
            }
        }

        // 显示模态框
        const createModal = new bootstrap.Modal(modal);
        createModal.show();
        console.log(`模态框已显示`);
    }

    // 查找分类名称
    async function findCategoryName(categoryId) {
        try {
            const response = await fetch(`/category/api/category/${categoryId}`);
            const data = await response.json();
            return data.success ? data.data.category.name : '未知分类';
        } catch (error) {
            console.error('Error finding category name:', error);
            return '未知分类';
        }
    }

    // 为创建分类加载父分类选项
    function loadParentCategoriesForCreate(level, selectElement) {
        fetch(`/category/api/parent-categories/${level}`)
            .then(response => response.json())
            .then(data => {
                selectElement.innerHTML = '<option value="">选择父分类</option>';
                if (data.success) {
                    data.data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        selectElement.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading parent categories:', error));
    }

    // 提交创建表单
    document.getElementById('createCategoryForm').addEventListener('submit', function (e) {
        e.preventDefault();

        console.log('开始提交创建分类表单');

        const level = parseInt(document.getElementById('createCategoryLevel').value);
        const name = document.getElementById('createCategoryName').value;

        // 获取父分类ID - 尝试多个来源
        const parentIdFromFixed = document.getElementById('createParentId').value;
        const parentIdFromCascade = document.getElementById('createParentCategoryId').value;
        const parentId = parentIdFromFixed || parentIdFromCascade || null;

        // 详细调试信息
        console.log('表单数据收集:', {
            level: level,
            name: name,
            parentIdFromFixed: parentIdFromFixed,
            parentIdFromCascade: parentIdFromCascade,
            finalParentId: parentId,
            fixedFieldElement: document.getElementById('createParentId') ? '存在' : '不存在',
            cascadeFieldElement: document.getElementById('createParentCategoryId') ? '存在' : '不存在',
            cascadeFieldValue: document.getElementById('createParentCategoryId') ? document.getElementById('createParentCategoryId').value : 'N/A'
        });

        // 验证必需的父分类
        if ((level === 2 || level === 3) && !parentId) {
            const message = `${level === 2 ? '二' : '三'}级分类必须选择父分类`;
            console.error(message);
            alert(message);
            return;
        }

        const requestData = {
            name: name,
            level: level,
            parent_id: parentId
        };

        console.log('即将发送的请求数据:', requestData);

        fetch('/api/category', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                console.log('收到服务器响应，状态码:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('服务器响应数据:', data);
                if (data.success) {
                    console.log('创建成功，重新加载页面');
                    location.reload();
                } else {
                    console.error('创建失败:', data.message);
                    alert('创建失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('请求错误:', error);
                alert('创建失败: ' + error.message);
            })
            .finally(() => {
                const createModal = bootstrap.Modal.getInstance(document.getElementById('createCategoryModal'));
                createModal.hide();
            });
    });

    // 编辑分类
    async function editCategory(button) {
        const categoryId = button.getAttribute('data-category-id');
        const categoryName = button.getAttribute('data-category-name');
        const categoryLevel = parseInt(button.getAttribute('data-category-level'));
        const categoryParent = button.getAttribute('data-category-parent');

        // 填充编辑表单
        document.getElementById('editCategoryId').value = categoryId;
        document.getElementById('editCategoryLevel').value = categoryLevel;
        document.getElementById('editCategoryName').value = categoryName;

        // 处理父分类选择（二级和三级分类可以选择父分类）
        const parentGroup = document.getElementById('editParentCategoryGroup');
        const level1Group = document.getElementById('editLevel1Group');
        const level2Group = document.getElementById('editLevel2Group');
        const level1Select = document.getElementById('editParentLevel1');
        const level2Select = document.getElementById('editParentLevel2');
        const parentCategoryIdInput = document.getElementById('editParentCategoryId');

        if (categoryLevel === 1) {
            // 一级分类不能选择父分类
            parentGroup.style.display = 'none';
        } else {
            // 显示父分类选择器
            parentGroup.style.display = 'block';

            // 加载分类树数据
            const treeData = await loadCategoryTreeData();

            if (categoryLevel === 2) {
                // 二级分类，只显示一级分类选择
                level1Group.style.display = 'block';
                level2Group.style.display = 'none';

                level1Select.innerHTML = '<option value="">设为顶级分类</option>' + generateLevel1Options(treeData);
                level2Select.innerHTML = '<option value="">请选择二级分类</option>';
                level2Select.disabled = true;

                // 设置当前父分类
                if (categoryParent) {
                    level1Select.value = categoryParent;
                    parentCategoryIdInput.value = categoryParent;
                }

            } else if (categoryLevel === 3) {
                // 三级分类，显示一级和二级分类选择
                level1Group.style.display = 'block';
                level2Group.style.display = 'block';

                level1Select.innerHTML = '<option value="">设为顶级分类</option>' + generateLevel1Options(treeData);
                level2Select.innerHTML = '<option value="">请选择二级分类</option>';
                level2Select.disabled = true;

                // 设置当前父分类
                if (categoryParent) {
                    await setCascadeFromParentId('editParent', categoryParent);
                    parentCategoryIdInput.value = categoryParent;
                }
            }

            // 设置事件监听器
            setupCascadeListeners('editParent');
        }

        // 显示模态框
        const editModal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        editModal.show();
    }

    // 为编辑分类加载父分类选项
    function loadParentCategoriesForEdit(categoryId, currentParent, selectElement) {
        fetch(`/category/api/category/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.data.parent_categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        // 显示分类级别和名称
                        const levelText = category.level === 1 ? '一级' : '二级';
                        option.textContent = `${levelText} - ${category.name}`;
                        if (category.id == currentParent) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading parent options:', error));
    }

    // 提交编辑表单
    document.getElementById('editCategoryForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const categoryId = document.getElementById('editCategoryId').value;
        const categoryName = document.getElementById('editCategoryName').value;
        const parentId = document.getElementById('editParentCategoryId').value || null;

        fetch(`/api/category/${categoryId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: categoryName,
                parent_id: parentId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('编辑失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('编辑失败: ' + error.message);
            })
            .finally(() => {
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
                editModal.hide();
            });
    });

    // 删除分类
    function deleteCategory(categoryId, categoryName) {
        deleteTargetId = categoryId;
        document.getElementById('deleteCategoryName').textContent = categoryName;

        // 重置界面
        document.getElementById('deleteWarningMessage').style.display = 'none';
        document.getElementById('deleteCascadeOption').style.display = 'none';
        document.getElementById('categoryUsageInfo').style.display = 'none';
        document.getElementById('itemsWarningMessage').style.display = 'none';
        document.getElementById('cascadeDelete').checked = false;
        document.getElementById('confirmDeleteBtn').disabled = false;

        // 获取分类使用信息
        fetch(`/api/category/${categoryId}/usage`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const usageInfo = data.data;

                    // 显示使用信息
                    document.getElementById('directItemsCount').textContent = usageInfo.direct_items_count;
                    document.getElementById('childrenCount').textContent = usageInfo.children_count;
                    document.getElementById('descendantCount').textContent = usageInfo.descendant_categories_count;
                    document.getElementById('descendantItemsCount').textContent = usageInfo.descendant_items_count;
                    document.getElementById('totalItemsCount').textContent = usageInfo.total_items_count;
                    document.getElementById('categoryUsageInfo').style.display = 'block';

                    // 检查是否有直接关联的商品
                    if (usageInfo.direct_items_count > 0) {
                        document.getElementById('itemsWarningText').textContent =
                            `该分类被 ${usageInfo.direct_items_count} 个商品引用，无法直接删除。`;
                        document.getElementById('itemsWarningMessage').style.display = 'block';
                        document.getElementById('confirmDeleteBtn').disabled = true;
                    }

                    // 检查是否有子分类
                    if (usageInfo.children_count > 0) {
                        document.getElementById('deleteWarningText').textContent =
                            `该分类下有 ${usageInfo.children_count} 个子分类。`;
                        document.getElementById('deleteWarningMessage').style.display = 'block';
                        document.getElementById('deleteCascadeOption').style.display = 'block';
                    }
                }

                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            })
            .catch(error => {
                console.error('Error getting category usage info:', error);
                // 即使检查失败也显示删除对话框
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            });
    }

    // 显示合并选项
    function showMergeOption() {
        // 关闭删除模态框
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        deleteModal.hide();

        // 准备合并模态框
        document.getElementById('sourceCategoryName').textContent =
            document.getElementById('deleteCategoryName').textContent;

        // 加载目标分类选项
        loadTargetCategories(deleteTargetId);

        // 显示合并模态框
        const mergeModal = new bootstrap.Modal(document.getElementById('mergeModal'));
        mergeModal.show();
    }

    // 直接显示合并模态框（从按钮调用）
    function showMergeModal(categoryId, categoryName, categoryLevel) {
        deleteTargetId = categoryId;

        // 设置源分类名称
        document.getElementById('sourceCategoryName').textContent = categoryName;

        // 加载目标分类选项
        loadTargetCategories(categoryId);

        // 显示合并模态框
        const mergeModal = new bootstrap.Modal(document.getElementById('mergeModal'));
        mergeModal.show();
    }

    // 加载目标分类选项
    function loadTargetCategories(excludeCategoryId) {
        const select = document.getElementById('targetCategorySelect');
        select.innerHTML = '<option value="">请选择目标分类</option>';

        // 获取当前分类信息以确定层级
        fetch(`/api/category/${excludeCategoryId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const sourceLevel = data.data.level;

                    // 获取同级分类作为目标选项
                    fetch('/api/category/tree')
                        .then(response => response.json())
                        .then(treeData => {
                            if (treeData.success) {
                                const categories = flattenCategoryTree(treeData.data);
                                const sameLevel = categories.filter(cat =>
                                    cat.level === sourceLevel && cat.id !== excludeCategoryId
                                );

                                sameLevel.forEach(category => {
                                    const option = document.createElement('option');
                                    option.value = category.id;
                                    option.textContent = getCategoryFullName(category, categories);
                                    select.appendChild(option);
                                });
                            }
                        });
                }
            });
    }

    // 确认合并
    function confirmMerge() {
        const targetCategoryId = document.getElementById('targetCategorySelect').value;
        const deleteSource = document.getElementById('deleteSourceAfterMerge').checked;

        if (!targetCategoryId) {
            alert('请选择目标分类');
            return;
        }

        const requestData = {
            source_category_id: deleteTargetId,
            target_category_id: parseInt(targetCategoryId),
            delete_source: deleteSource
        };

        fetch('/api/category/merge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('分类合并成功！');
                    location.reload();
                } else {
                    alert('合并失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error merging categories:', error);
                alert('合并失败: ' + error.message);
            });

        // 关闭模态框
        const mergeModal = bootstrap.Modal.getInstance(document.getElementById('mergeModal'));
        mergeModal.hide();
    }

    // 辅助函数：扁平化分类树
    function flattenCategoryTree(tree) {
        const result = [];

        function flatten(categories, parentPath = '') {
            categories.forEach(category => {
                const fullPath = parentPath ? `${parentPath} > ${category.name}` : category.name;
                result.push({
                    ...category,
                    fullPath: fullPath
                });

                if (category.children && category.children.length > 0) {
                    flatten(category.children, fullPath);
                }
            });
        }

        flatten(tree);
        return result;
    }

    // 辅助函数：获取分类完整名称
    function getCategoryFullName(category, allCategories) {
        return category.fullPath || category.name;
    }

    function confirmDelete() {
        if (!deleteTargetId) return;

        const cascade = document.getElementById('cascadeDelete').checked;
        const url = `/api/category/${deleteTargetId}${cascade ? '?cascade=true' : ''}`;

        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload(); // 刷新页面
                } else {
                    if (data.has_children && !cascade) {
                        // 如果有子分类但没有选择级联删除，显示详细信息
                        alert(`删除失败: ${data.message}\n\n请选择级联删除选项来同时删除所有子分类。`);
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败: ' + error.message);
            })
            .finally(() => {
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                if (deleteModal) {
                    deleteModal.hide();
                }
                deleteTargetId = null;
            });
    }
</script>
{% endblock %}