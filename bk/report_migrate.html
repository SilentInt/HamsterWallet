<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>个人消费分析报告</title>
    <!-- Tailwind CSS CDN (v3 - stable) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <!-- Font Awesome CDN (Updated) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Chart.js CDN (Updated) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
      integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- Luxon CDN (Updated) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.5.0/luxon.min.js"
      integrity="sha512-SN7iwxiJt9nFKiLayg3NjLItXPwRfBr4SQSIugMeBFrD4lIFJe1Z/exkTZYAg3Ul+AfZEGws2PQ+xSoaWfxRQQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- Chart.js Date Adapter for Luxon (Updated) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-luxon/1.3.1/chartjs-adapter-luxon.umd.min.js"
      integrity="sha512-I8SeDoNxRKOuQMhqHmx95hydiG/LCY9SFCs3cqAf+f1kIZbAyXXIXIIwgx32ZIgZpOVrEOHSfyjeKxRNIuBvWQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- PapaParse CDN (Still current) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
      integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      /* Styles as provided previously, with additions */
      body {
        background-color: #000000;
        color: #f0f0f0; /* Lighter gray for base text */
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji";
      }

      .main-card {
        background-color: #1a1a1a;
        border-radius: 1rem; /* rounded-xl */
        padding: 1.5rem; /* p-6 */
        margin-bottom: 2rem; /* mb-8 */
        border: 1px solid #333333;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        opacity: 0;
        transform: translateY(20px);
      }

      .mini-card {
        background-color: #222222;
        border-radius: 0.75rem; /* rounded-lg */
        padding: 1rem; /* p-4 */
        border: 1px solid #444444; /* Slightly lighter border for mini cards */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow-sm */
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        opacity: 0;
        transform: translateY(20px);
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Helps align content */
        height: 100%; /* Ensure cards in a row have same height */
      }

      .highlight-green {
        color: #2ecc71;
      }
      .highlight-blue {
        color: #00aeef;
      }
      .highlight-orange {
        /* For Discount info */
        color: #e67e22;
      }

      .gradient-bg-green {
        background-image: linear-gradient(
          to bottom,
          rgba(46, 204, 113, 0.15),
          rgba(46, 204, 113, 0.05)
        );
      }

      .animate-on-scroll {
        /* Base styles set in .main-card and .mini-card */
      }
      .is-visible {
        opacity: 1;
        transform: translateY(0);
      }

      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f1f1f; /* Darker track for list */
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #444;
        border-radius: 4px;
        border: 2px solid #1f1f1f;
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: #555;
      }
      /* Specific scrollbar for item list container */
      #item-list-container::-webkit-scrollbar-track {
        /* Updated ID */
        background: #2a2a2a;
      }
      #item-list-container::-webkit-scrollbar-thumb {
        /* Updated ID */
        background-color: #555;
        border: 2px solid #2a2a2a;
      }
      #item-list-container::-webkit-scrollbar-thumb:hover {
        /* Updated ID */
        background-color: #666;
      }

      .icon-inline {
        display: inline-block;
        vertical-align: middle;
        margin-right: 0.3em;
      }

      .back-button {
        background-color: #333;
        color: #eee;
        padding: 0.3rem 0.8rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        vertical-align: middle;
      }
      .back-button:hover {
        background-color: #444;
      }
      .back-button:disabled {
        background-color: #2a2a2a;
        color: #666;
        cursor: not-allowed;
      }

      /* Styles for Filter Controls */
      .filter-controls {
        background-color: #1f1f1f;
        border-radius: 0.75rem;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #333;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
      }
      .filter-controls label {
        font-size: 0.9rem;
        color: #bbb;
      }
      .filter-controls input[type="date"] {
        background-color: #333;
        border: 1px solid #555;
        color: #eee;
        border-radius: 0.375rem;
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
        color-scheme: dark; /* Improves date picker appearance in dark mode */
      }
      .filter-controls input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
      } /* Make calendar icon lighter */
      .filter-button {
        background-color: #2ecc71;
        color: #111;
        padding: 0.4rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .filter-button:hover {
        background-color: #27ae60;
      }
      .filter-button:disabled {
        background-color: #555;
        color: #999;
        cursor: not-allowed;
      }
      .reset-button {
        background-color: #555;
        color: #eee;
        padding: 0.4rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
        font-size: 0.9rem;
        font-weight: 500;
        margin-left: 0.5rem;
      }
      .reset-button:hover {
        background-color: #666;
      }

      /* Item list specific styles (used for both category and daily lists) */
      .item-entry {
        /* Renamed from category-item */
        background-color: #282828;
        padding: 0.75rem 1rem; /* p-3 p-4 */
        border-radius: 0.5rem; /* rounded-lg */
        border: 1px solid #3a3a3a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem; /* space-x-4 */
        transition: background-color 0.2s;
      }
      .item-entry:hover {
        background-color: #333333;
      }
      .item-details {
        flex-grow: 1;
        min-width: 0; /* Prevent overflow */
      }
      .item-name {
        display: block;
        font-weight: 500; /* medium */
        color: #e0e0e0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.1rem;
      }
      .item-meta {
        font-size: 0.75rem; /* text-xs */
        color: #888888;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .item-price {
        font-weight: 600; /* semibold */
        color: #2ecc71; /* highlight-green */
        font-size: 1rem; /* text-base */
        white-space: nowrap;
        margin-left: 1rem; /* ml-4 */
      }
      .item-discount-icon {
        /* Style for discount icon */
        font-size: 0.7rem;
        color: #e67e22; /* highlight-orange */
        margin-left: 0.3em;
        vertical-align: text-top; /* Align slightly above baseline */
      }
    </style>
  </head>
  <body class="bg-black text-gray-100 font-sans">
    <div class="container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
      <!-- Main Title -->
      <div class="text-center mb-8 md:mb-12 animate-on-scroll">
        <h1
          id="report-title"
          class="text-5xl lg:text-6xl font-bold text-white mb-2"
        ></h1>
        <p
          id="report-subtitle"
          class="text-xl lg:text-2xl font-semibold text-gray-400"
        ></p>
        <p id="report-date-range" class="text-sm text-gray-500 mt-2"></p>
      </div>

      <!-- Date Filter Section -->
      <div id="filter-section" class="filter-controls animate-on-scroll">
        <label for="start-date">开始日期:</label>
        <input type="date" id="start-date" name="start-date" />

        <label for="end-date" class="ml-2 sm:ml-0">结束日期:</label>
        <input type="date" id="end-date" name="end-date" />

        <button id="filter-button" class="filter-button ml-auto" disabled>
          <i class="fas fa-filter mr-1"></i> 筛选
        </button>
        <button id="reset-button" class="reset-button" disabled>
          <i class="fas fa-undo mr-1"></i> 重置
        </button>
      </div>

      <!-- Section: Overview -->
      <div class="main-card animate-on-scroll gradient-bg-green">
        <h2 class="text-2xl font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-chart-pie icon-inline text-[#2ECC71]"></i>消费总览
        </h2>
        <!-- UPDATED Grid: Added 3 new cards -->
        <div
          id="overview-grid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
        >
          <!-- Existing Cards -->
          <div class="mini-card animate-on-scroll">
            <span
              id="total-spend"
              class="text-4xl sm:text-5xl font-bold highlight-green mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">总支出</span>
            <span class="text-xs text-gray-500 mt-1 block"
              >Total Expenditure</span
            >
          </div>
          <div class="mini-card animate-on-scroll">
            <span
              id="transaction-count"
              class="text-4xl sm:text-5xl font-bold highlight-green mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">总交易笔数</span>
            <span class="text-xs text-gray-500 mt-1 block"
              >Total Transactions</span
            >
          </div>
          <div class="mini-card animate-on-scroll">
            <span
              id="average-spend"
              class="text-4xl sm:text-5xl font-bold highlight-green mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">平均每笔交易</span>
            <span class="text-xs text-gray-500 mt-1 block"
              >Average Transaction Value</span
            >
          </div>
          <div class="mini-card animate-on-scroll">
            <span
              id="reporting-days"
              class="text-4xl sm:text-5xl font-bold highlight-green mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">记录天数</span>
            <span class="text-xs text-gray-500 mt-1 block">Days Recorded</span>
          </div>

          <!-- NEW Cards -->
          <div class="mini-card animate-on-scroll">
            <span
              id="daily-average-spend"
              class="text-4xl sm:text-5xl font-bold highlight-green mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">每日平均支出</span>
            <span class="text-xs text-gray-500 mt-1 block"
              >Daily Average Spend</span
            >
          </div>
          <div class="mini-card animate-on-scroll">
            <span
              id="discounted-count"
              class="text-4xl sm:text-5xl font-bold highlight-orange mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">折扣商品数量</span>
            <span class="text-xs text-gray-500 mt-1 block"
              >Discounted Items</span
            >
          </div>
          <div class="mini-card animate-on-scroll">
            <span
              id="discounted-percentage"
              class="text-4xl sm:text-5xl font-bold highlight-orange mb-1 block truncate"
              >--</span
            >
            <span class="text-sm text-gray-400">折扣商品占比</span>
            <span class="text-xs text-gray-500 mt-1 block"
              >Discount Item Ratio</span
            >
          </div>
        </div>
        <p
          id="overview-nodata-message"
          class="text-gray-400 text-center mt-4 hidden"
        >
          此时间范围内无有效数据。
        </p>
      </div>

      <!-- Section: Spending Trend -->
      <div class="main-card animate-on-scroll">
        <h2 class="text-2xl font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-chart-line icon-inline text-[#2ECC71]"></i>消费趋势
        </h2>
        <div class="chart-container" style="height: 350px">
          <canvas id="spendingTrendChart"></canvas>
          <p
            id="trend-nodata-message"
            class="text-gray-400 text-center absolute inset-0 flex items-center justify-center hidden"
          >
            无趋势数据可显示。
          </p>
        </div>
        <p class="text-xs text-gray-500 text-center mt-2">
          点击图表中某一天查看当天购物列表
        </p>
      </div>

      <!-- Section: Category Breakdown / Daily Item List (Interactive) -->
      <!-- UPDATED: This section now serves both category drilldown and daily item list -->
      <div class="main-card animate-on-scroll">
        <div class="flex items-center mb-4">
          <h2
            class="text-2xl font-semibold text-white flex items-center mr-auto"
            id="interactive-section-title"
          >
            <i class="fas fa-tags icon-inline text-[#2ECC71]"></i>
            <span id="category-chart-title">分类支出分析</span>
            <!-- Icon and title will change dynamically -->
          </h2>
          <button id="interactive-back-button" class="back-button" disabled>
            <i class="fas fa-arrow-left mr-1"></i> 返回
          </button>
        </div>
        <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">
          <!-- Left Column: Chart (Only for Category view) -->
          <div id="category-chart-column" class="w-full lg:w-1/2">
            <div class="chart-container" style="height: 400px">
              <canvas id="categorySpendChart"></canvas>
              <p
                id="category-chart-nodata-message"
                class="text-gray-400 text-center absolute inset-0 flex items-center justify-center hidden"
              >
                无分类数据可显示。
              </p>
            </div>
          </div>
          <!-- Right Column: Item List (Used for both views) -->
          <!-- UPDATED: Changed IDs for clarity -->
          <div id="item-list-column" class="w-full lg:w-1/2">
            <h3
              id="item-list-title"
              class="text-lg font-semibold text-gray-300 mb-3"
            >
              商品列表
            </h3>
            <div
              id="item-list-container"
              class="space-y-2 max-h-[400px] overflow-y-auto pr-2"
            >
              <!-- Item list will be populated here by JS -->
            </div>
            <p
              id="item-list-nodata"
              class="text-gray-400 text-center mt-4 hidden"
            >
              无商品记录。
            </p>
          </div>
        </div>
      </div>

      <!-- Section: Shop Analysis -->
      <div id="shop-analysis-section" class="main-card animate-on-scroll">
        <h2 class="text-2xl font-semibold text-white mb-4 flex items-center">
          <i class="fas fa-store icon-inline text-[#00AEEF]"></i>消费场所分析
        </h2>
        <div class="flex flex-col lg:flex-row gap-6">
          <div class="lg:w-1/3">
            <h3
              class="text-lg font-semibold text-gray-300 mb-3 text-center lg:text-left"
            >
              场所类型分布
            </h3>
            <div class="chart-container" style="height: 250px">
              <canvas id="shopCategoryChart"></canvas>
              <p
                id="shop-chart-nodata-message"
                class="text-gray-400 text-center absolute inset-0 flex items-center justify-center hidden"
              >
                无场所类型数据
              </p>
            </div>
          </div>
          <div class="lg:w-2/3">
            <h3 class="text-lg font-semibold text-gray-300 mb-3">
              主要消费场所类型
            </h3>
            <div
              id="top-shop-categories-grid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
            >
              <p
                id="shop-list-nodata-message"
                class="text-gray-400 text-center col-span-full"
              >
                无场所类型数据可显示。
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer
        class="text-center text-gray-500 text-sm mt-12 pb-8 animate-on-scroll"
      >
        报告生成于 <span id="generation-date"></span>. 数据来源: 个人消费记录
        CSV.
      </footer>
    </div>

    <script>
      // --- Global Variables ---
      const highlightColor = "#2ECC71";
      const secondaryColor = "#3498DB";
      const shopAnalysisColor = "#00AEEF";
      const discountColor = "#E67E22"; // Orange for discounts
      const chartTextColor = "#e0e0e0";
      const chartGridColor = "#444444";

      let originalTransactions = [];
      let currentFilteredTransactions = [];
      let categoryHierarchyData = {};
      let currentCategoryLevel = 1;
      let currentCategoryPath = [];
      let globalCurrentTotalSpend = 0;
      let currentViewMode = "category"; // 'category' or 'daily'

      // Chart instances
      let spendingTrendChartInstance = null;
      let categoryChartInstance = null;
      let shopChartInstance = null;

      // --- DOM Elements ---
      const el = {
        reportTitle: document.getElementById("report-title"),
        reportSubtitle: document.getElementById("report-subtitle"),
        reportDateRange: document.getElementById("report-date-range"),
        startDateInput: document.getElementById("start-date"),
        endDateInput: document.getElementById("end-date"),
        filterButton: document.getElementById("filter-button"),
        resetButton: document.getElementById("reset-button"),
        overviewGrid: document.getElementById("overview-grid"),
        overviewNoData: document.getElementById("overview-nodata-message"),
        totalSpend: document.getElementById("total-spend"),
        transactionCount: document.getElementById("transaction-count"),
        averageSpend: document.getElementById("average-spend"),
        reportingDays: document.getElementById("reporting-days"),
        // NEW Overview Elements
        dailyAverageSpend: document.getElementById("daily-average-spend"),
        discountedCount: document.getElementById("discounted-count"),
        discountedPercentage: document.getElementById("discounted-percentage"),
        // Trend Chart
        spendingTrendCanvas: document.getElementById("spendingTrendChart"),
        trendNoData: document.getElementById("trend-nodata-message"),
        // Interactive Section (Category/Daily)
        interactiveSectionTitle: document.getElementById(
          "interactive-section-title"
        ), // H2 containing icon and title span
        categoryChartTitle: document.getElementById("category-chart-title"), // Span inside H2
        interactiveBackButton: document.getElementById(
          "interactive-back-button"
        ), // Renamed back button
        categoryChartColumn: document.getElementById("category-chart-column"), // Column holding the category chart
        categoryChartCanvas: document.getElementById("categorySpendChart"),
        categoryChartNoData: document.getElementById(
          "category-chart-nodata-message"
        ),
        itemListColumn: document.getElementById("item-list-column"), // Column holding the item list
        itemListTitle: document.getElementById("item-list-title"), // H3 above the list
        itemListContainer: document.getElementById("item-list-container"), // Div containing the list items
        itemListNoData: document.getElementById("item-list-nodata"), // No data message for the list
        // Shop Analysis
        shopAnalysisSection: document.getElementById("shop-analysis-section"),
        shopCategoryChartCanvas: document.getElementById("shopCategoryChart"),
        shopChartNoData: document.getElementById("shop-chart-nodata-message"),
        topShopCategoriesGrid: document.getElementById(
          "top-shop-categories-grid"
        ),
        shopListNoData: document.getElementById("shop-list-nodata-message"),
        generationDate: document.getElementById("generation-date"),
      };

      // --- Utility Functions ---
      // Keep existing utility functions: formatCurrency, getCategoryIcon, getEnglishCategory, hexToRgb, hexToRgba, rgbToHsv, hsvToRgb, generateVibrantColors, calculateTimeUnit
      function formatCurrency(value) {
        if (typeof value !== "number" || isNaN(value)) return "¥--";
        return `¥${value.toFixed(2)}`;
      }
      function getCategoryIcon(category) {
        const icons = {
          食品: "fa-utensils",
          日用品: "fa-shopping-basket",
          商超: "fa-store",
          餐饮店: "fa-utensils",
          便利店: "fa-shopping-cart",
          药妆店: "fa-pills",
          电器店: "fa-plug",
          家具店: "fa-couch",
          医疗保健: "fa-briefcase-medical",
          服装鞋帽: "fa-shirt",
          办公文具: "fa-pen-ruler",
          美妆个护: "fa-air-freshener",
          饮料酒水: "fa-wine-bottle",
          生鲜冷冻: "fa-carrot",
          零食糖果: "fa-cookie-bite",
          交通出行: "fa-bus",
          通讯服务: "fa-wifi",
          休闲娱乐: "fa-film",
          教育培训: "fa-graduation-cap",
          住房物业: "fa-home",
          其他: "fa-question-circle",
          未知类型: "fa-map-marker-alt",
          未分类: "fa-question-circle",
        };
        return icons[category] || "fa-dollar-sign";
      }
      const categoryTranslations = {
        食品: "Food & Groceries",
        日用品: "Daily Necessities",
        商超: "Supermarket",
        餐饮店: "Restaurant",
        便利店: "Convenience Store",
        药妆店: "Drugstore",
        电器店: "Electronics Store",
        家具店: "Furniture Store",
        医疗保健: "Healthcare",
        服装鞋帽: "Apparel & Shoes",
        办公文具: "Office Supplies",
        美妆个护: "Beauty & Personal Care",
        饮料酒水: "Beverages",
        生鲜冷冻: "Fresh & Frozen",
        零食糖果: "Snacks & Sweets",
        交通出行: "Transportation",
        通讯服务: "Communication",
        休闲娱乐: "Entertainment",
        教育培训: "Education",
        住房物业: "Housing",
        其他: "Other",
        未知类型: "Unknown Type",
        未分类: "Uncategorized",
        主食: "Staple Food",
        蔬菜菌菇: "Vegetables",
        清洁用品: "Cleaning",
        厨房用品: "Kitchenware",
        米饭: "Rice",
        面条: "Noodles",
      };
      function getEnglishCategory(chineseCategory) {
        return categoryTranslations[chineseCategory] || "Category";
      }
      function hexToRgb(hex) {
        if (!hex || typeof hex !== "string") return null;
        let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(
          shorthandRegex,
          (m, r, g, b) => r + r + g + g + b + b
        );
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }
      function hexToRgba(hex, alpha = 1) {
        const rgb = hexToRgb(hex);
        if (!rgb) return `rgba(200, 200, 200, ${alpha})`;
        return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
      }
      function rgbToHsv(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        let max = Math.max(r, g, b),
          min = Math.min(r, g, b);
        let h,
          s,
          v = max;
        let d = max - min;
        s = max == 0 ? 0 : d / max;
        if (max == min) {
          h = 0;
        } else {
          switch (max) {
            case r:
              h = (g - b) / d + (g < b ? 6 : 0);
              break;
            case g:
              h = (b - r) / d + 2;
              break;
            case b:
              h = (r - g) / d + 4;
              break;
          }
          h /= 6;
        }
        return [h * 360, s, v];
      }
      function hsvToRgb(h, s, v) {
        let r, g, b;
        h /= 360;
        let i = Math.floor(h * 6);
        let f = h * 6 - i;
        let p = v * (1 - s);
        let q = v * (1 - f * s);
        let t = v * (1 - (1 - f) * s);
        switch (i % 6) {
          case 0:
            r = v;
            g = t;
            b = p;
            break;
          case 1:
            r = q;
            g = v;
            b = p;
            break;
          case 2:
            r = p;
            g = v;
            b = t;
            break;
          case 3:
            r = p;
            g = q;
            b = v;
            break;
          case 4:
            r = t;
            g = p;
            b = v;
            break;
          case 5:
            r = v;
            g = p;
            b = q;
            break;
        }
        return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
      }
      function generateVibrantColors(count, baseColorHex) {
        const colors = [];
        const baseColor = hexToRgb(baseColorHex);
        if (!baseColor) return Array(count).fill("#CCCCCC");
        const baseHsv = rgbToHsv(baseColor.r, baseColor.g, baseColor.b);
        const baseHue = baseHsv[0];
        const goldenAngle = 137.5;
        for (let i = 0; i < count; i++) {
          const hue = (baseHue + i * goldenAngle) % 360;
          const satVar = 0.8 + 0.2 * Math.sin((i * Math.PI) / (count / 2));
          const saturation = Math.max(0.6, Math.min(1, baseHsv[1] * satVar));
          const valVar = 0.85 + 0.15 * Math.cos((i * Math.PI) / (count / 2));
          const value = Math.max(0.7, Math.min(1, baseHsv[2] * valVar));
          const rgb = hsvToRgb(hue, saturation, value);
          colors.push(`rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.85)`);
        }
        if (colors.length > 0) {
          const firstRgb = hsvToRgb(
            baseHue,
            Math.min(1, baseHsv[1] * 1.1),
            Math.min(1, baseHsv[2] * 1.05)
          );
          colors[0] = `rgba(${firstRgb[0]}, ${firstRgb[1]}, ${firstRgb[2]}, 0.9)`;
        }
        return colors;
      }
      function calculateTimeUnit(startDate, endDate) {
        if (!startDate || !endDate) return "day";
        const diffDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
        if (diffDays <= 0) return "day";
        else if (diffDays <= 35) return "day";
        else if (diffDays <= 180) return "week";
        else return "month";
      }

      // --- Data Processing and Cleaning ---
      function cleanTransactionData(rawData) {
        // Added is_special parsing
        return rawData
          .map((item) => {
            let price = parseFloat(item.cny_price);
            if (isNaN(price) || price <= 0) {
              const jpyPrice = parseFloat(item.jpy_price);
              if (!isNaN(jpyPrice) && jpyPrice > 0) {
                price = jpyPrice * 0.05; // Example conversion rate
              } else {
                price = 0;
              }
            }
            const cat1 = (item.category_1 || "").trim() || "未分类";
            const cat2 = (item.category_2 || "").trim();
            const cat3 = (item.category_3 || "").trim();
            const isSpecial =
              (item.is_special || "").trim().toLowerCase() != "否"; // Check for '是'

            let timestamp = null;
            let dateStr = null; // YYYY-MM-DD format
            try {
              // Attempt parsing common formats
              let parsedDate = luxon.DateTime.fromISO(
                item.timestamp
              ).toJSDate();
              if (isNaN(parsedDate.getTime())) {
                parsedDate = luxon.DateTime.fromFormat(
                  item.timestamp,
                  "yyyy-MM-dd HH:mm"
                ).toJSDate();
              }
              // Add more formats if needed

              if (!isNaN(parsedDate.getTime())) {
                timestamp = parsedDate;
                const year = timestamp.getFullYear();
                const month = (timestamp.getMonth() + 1)
                  .toString()
                  .padStart(2, "0");
                const day = timestamp.getDate().toString().padStart(2, "0");
                dateStr = `${year}-${month}-${day}`;
              } else {
                console.warn("Could not parse timestamp:", item.timestamp);
              }
            } catch (e) {
              console.error("Error parsing timestamp:", item.timestamp, e);
            }

            return {
              ...item,
              cny_price: price,
              timestamp: timestamp,
              dateStr: dateStr, // Add YYYY-MM-DD string
              category_1: cat1,
              category_2: cat2,
              category_3: cat3,
              is_special: isSpecial, // Boolean flag
              chinese_name:
                item.chinese_name || item.japanese_name || "未知商品",
              shop_category: (item.shop_category || "").trim() || "未知类型",
            };
          })
          .filter(
            (item) => item.cny_price > 0 && item.timestamp && item.dateStr
          ) // Ensure timestamp and dateStr are valid
          .sort((a, b) => a.timestamp - b.timestamp);
      }

      // --- Report Rendering Function ---
      function renderReport(transactionsToRender) {
        console.log(
          `Rendering report with ${transactionsToRender.length} transactions.`
        );
        currentFilteredTransactions = transactionsToRender; // Update global list

        // --- Clear Previous State / Charts ---
        if (spendingTrendChartInstance) spendingTrendChartInstance.destroy();
        if (categoryChartInstance) categoryChartInstance.destroy();
        if (shopChartInstance) shopChartInstance.destroy();
        categoryChartInstance = null;
        spendingTrendChartInstance = null;
        shopChartInstance = null;
        resetToCategoryView(); // Reset interactive view to default category

        // --- Handle No Data Case ---
        const hasData = transactionsToRender && transactionsToRender.length > 0;
        el.overviewGrid.style.display = hasData ? "grid" : "none";
        el.overviewNoData.style.display = hasData ? "none" : "block";
        el.trendNoData.style.display = hasData ? "none" : "block";
        el.categoryChartNoData.style.display = hasData ? "none" : "block";
        el.shopChartNoData.style.display = hasData ? "none" : "block";
        el.shopListNoData.style.display = hasData ? "none" : "block";
        el.topShopCategoriesGrid.style.display = hasData ? "grid" : "none";
        el.topShopCategoriesGrid.innerHTML = ""; // Clear grid content
        el.itemListContainer.innerHTML = ""; // Clear item list
        el.itemListNoData.style.display = hasData ? "none" : "block";

        if (!hasData) {
          console.warn("No data to render.");
          el.reportDateRange.textContent = "当前筛选范围内无数据";
          el.totalSpend.textContent = formatCurrency(0);
          el.transactionCount.textContent = "0";
          el.averageSpend.textContent = formatCurrency(0);
          el.reportingDays.textContent = "0";
          el.dailyAverageSpend.textContent = formatCurrency(0);
          el.discountedCount.textContent = "0";
          el.discountedPercentage.textContent = "0%";
          el.itemListTitle.textContent = "商品列表"; // Reset title
          clearCanvas(el.spendingTrendCanvas);
          clearCanvas(el.categoryChartCanvas);
          clearCanvas(el.shopCategoryChartCanvas);
          return; // Stop further processing
        }

        // --- Calculate Metrics ---
        globalCurrentTotalSpend = transactionsToRender.reduce(
          (sum, item) => sum + item.cny_price,
          0
        );
        const transactionCount = transactionsToRender.length;
        const averageSpend =
          transactionCount > 0 ? globalCurrentTotalSpend / transactionCount : 0;

        const firstDate = transactionsToRender[0].timestamp;
        const lastDate =
          transactionsToRender[transactionsToRender.length - 1].timestamp;
        const reportingDays = calculateReportingDays(transactionsToRender); // Use helper function for accuracy
        const dailyAverageSpend =
          reportingDays > 0 ? globalCurrentTotalSpend / reportingDays : 0;

        const discountedItems = transactionsToRender.filter(
          (item) => item.is_special
        );
        const discountedCount = discountedItems.length;
        const discountedPercentage =
          transactionCount > 0 ? (discountedCount / transactionCount) * 100 : 0;

        // Update Date Range Display
        const startDateStr = firstDate.toLocaleDateString("zh-CN");
        const endDateStr = lastDate.toLocaleDateString("zh-CN");
        if (el.startDateInput.value || el.endDateInput.value) {
          el.reportDateRange.textContent = `数据显示范围: ${startDateStr} 至 ${endDateStr}`;
        } else {
          el.reportDateRange.textContent = `全部数据范围: ${startDateStr} 至 ${endDateStr}`;
        }

        // --- Populate Overview ---
        el.totalSpend.textContent = formatCurrency(globalCurrentTotalSpend);
        el.transactionCount.textContent = transactionCount;
        el.averageSpend.textContent = formatCurrency(averageSpend);
        el.reportingDays.textContent = reportingDays;
        el.dailyAverageSpend.textContent = formatCurrency(dailyAverageSpend); // New
        el.discountedCount.textContent = discountedCount; // New
        el.discountedPercentage.textContent = `${discountedPercentage.toFixed(
          1
        )}%`; // New

        // --- Spending Trend ---
        const spendingByDate = transactionsToRender.reduce((acc, item) => {
          const date = item.dateStr; // Use YYYY-MM-DD string
          acc[date] = (acc[date] || 0) + item.cny_price;
          return acc;
        }, {});
        const sortedDates = Object.keys(spendingByDate).sort();
        const trendLabels = sortedDates;
        const trendData = sortedDates.map((date) => spendingByDate[date]);

        if (trendLabels.length > 0) {
          el.trendNoData.style.display = "none";
          const ctxTrend = el.spendingTrendCanvas.getContext("2d");
          spendingTrendChartInstance = new Chart(ctxTrend, {
            type: "line",
            data: {
              labels: trendLabels, // Use YYYY-MM-DD strings as labels
              datasets: [
                {
                  label: "每日支出",
                  data: trendData,
                  borderColor: secondaryColor,
                  backgroundColor: hexToRgba(secondaryColor, 0.1),
                  tension: 0.1,
                  pointBackgroundColor: secondaryColor,
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  type: "time",
                  time: {
                    parser: "yyyy-MM-dd", // Tell Chart.js how to parse the labels
                    unit: calculateTimeUnit(firstDate, lastDate),
                    tooltipFormat: "yyyy-MM-dd", // Luxon format string
                    displayFormats: {
                      day: "MM-dd",
                      week: "yyyy-MM-dd",
                      month: "yyyy-MM",
                    },
                  },
                  grid: { color: chartGridColor },
                  ticks: {
                    color: chartTextColor,
                    maxRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: 10,
                  },
                  title: { display: true, text: "日期", color: chartTextColor },
                },
                y: {
                  beginAtZero: true,
                  grid: { color: chartGridColor },
                  ticks: { color: chartTextColor, callback: (v) => "¥" + v },
                  title: {
                    display: true,
                    text: "支出金额 (CNY)",
                    color: chartTextColor,
                  },
                },
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  mode: "index",
                  intersect: false,
                  callbacks: {
                    title: (items) => {
                      // items[0].label is the 'yyyy-MM-dd' string
                      return luxon.DateTime.fromISO(items[0].label)
                        .setLocale("zh-CN")
                        .toLocaleString(luxon.DateTime.DATE_FULL);
                    },
                    label: (ctx) =>
                      `${ctx.dataset.label || ""}: ${formatCurrency(
                        ctx.parsed.y
                      )}`,
                  },
                },
              },
              interaction: { mode: "nearest", axis: "x", intersect: false },
              // ADDED onClick for daily list
              onClick: handleSpendingTrendClick,
            },
          });
        } else {
          el.trendNoData.style.display = "block";
          clearCanvas(el.spendingTrendCanvas);
        }

        // --- Category Hierarchy Aggregation ---
        categoryHierarchyData = {}; // Rebuild for the filtered data
        transactionsToRender.forEach((item) => {
          const { category_1, category_2, category_3, cny_price } = item;
          if (!categoryHierarchyData[category_1])
            categoryHierarchyData[category_1] = {
              _total: 0,
              _items: [],
              _children: {},
            };
          categoryHierarchyData[category_1]._total += cny_price;
          categoryHierarchyData[category_1]._items.push(item);

          if (category_2) {
            if (!categoryHierarchyData[category_1]._children[category_2])
              categoryHierarchyData[category_1]._children[category_2] = {
                _total: 0,
                _items: [],
                _children: {},
              };
            categoryHierarchyData[category_1]._children[category_2]._total +=
              cny_price;
            categoryHierarchyData[category_1]._children[category_2]._items.push(
              item
            );

            if (category_3) {
              if (
                !categoryHierarchyData[category_1]._children[category_2]
                  ._children[category_3]
              )
                categoryHierarchyData[category_1]._children[
                  category_2
                ]._children[category_3] = {
                  _total: 0,
                  _items: [],
                  _children: {},
                };
              categoryHierarchyData[category_1]._children[category_2]._children[
                category_3
              ]._total += cny_price;
              categoryHierarchyData[category_1]._children[category_2]._children[
                category_3
              ]._items.push(item);
            }
          }
        });

        // --- Initial Category Chart Display & Item List ---
        updateCategoryChart(1, []); // Renders level 1 category chart AND overall item list by default

        // --- Shop Category Analysis ---
        const shopCategorySpend = transactionsToRender.reduce((acc, item) => {
          const shopCat = item.shop_category || "未知类型";
          acc[shopCat] = (acc[shopCat] || 0) + item.cny_price;
          return acc;
        }, {});
        const sortedShopCategories = Object.entries(shopCategorySpend).sort(
          ([, a], [, b]) => b - a
        );

        const shopLabels = sortedShopCategories.map(([category]) => category);
        const shopData = sortedShopCategories.map(([, amount]) => amount);
        const shopChartContainer = el.shopCategoryChartCanvas.parentElement;

        if (shopLabels.length > 0) {
          el.shopChartNoData.style.display = "none";
          shopChartContainer.style.display = "block"; // Make sure container is visible
          const ctxShop = el.shopCategoryChartCanvas.getContext("2d");
          shopChartInstance = new Chart(ctxShop, {
            type: "pie",
            data: {
              labels: shopLabels,
              datasets: [
                {
                  label: "场所类型支出",
                  data: shopData,
                  backgroundColor: generateVibrantColors(
                    shopLabels.length,
                    shopAnalysisColor
                  ),
                  borderColor: "#1a1a1a",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: shopLabels.length <= 8,
                  position: "bottom",
                  labels: { color: chartTextColor, boxWidth: 10, padding: 10 },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.label || "";
                      if (label) label += ": ";
                      if (context.parsed !== null) {
                        const amount = context.parsed;
                        label += formatCurrency(amount);
                        const percentage =
                          globalCurrentTotalSpend > 0
                            ? (
                                (amount / globalCurrentTotalSpend) *
                                100
                              ).toFixed(1)
                            : 0;
                        label += ` (${percentage}% of current total)`;
                      }
                      return label;
                    },
                  },
                },
                title: { display: false },
              },
            },
          });
        } else {
          el.shopChartNoData.style.display = "block";
          shopChartContainer.style.display = "block"; // Ensure container is visible even if chart is empty
          clearCanvas(el.shopCategoryChartCanvas);
        }

        // --- Top Shop Category Mini-Cards ---
        el.topShopCategoriesGrid.innerHTML = "";
        if (sortedShopCategories.length > 0) {
          el.shopListNoData.style.display = "none";
          el.topShopCategoriesGrid.style.display = "grid";
          sortedShopCategories
            .slice(0, 6)
            .forEach(([shopCat, amount], index) => {
              const percentage =
                globalCurrentTotalSpend > 0
                  ? ((amount / globalCurrentTotalSpend) * 100).toFixed(1)
                  : 0;
              const iconClass = getCategoryIcon(shopCat);
              const englishShopCat = getEnglishCategory(shopCat);
              const card = document.createElement("div");
              card.className = "mini-card animate-on-scroll";
              card.style.transitionDelay = `${index * 80}ms`;
              card.innerHTML = `
                    <div>
                        <span class="text-xl lg:text-2xl font-bold text-white block mb-1">
                        <i class="fas ${iconClass} icon-inline highlight-blue mr-2"></i>${shopCat}
                        </span>
                        ${
                          englishShopCat
                            ? `<span class="text-xs text-gray-500 block mb-2">${englishShopCat}</span>`
                            : ""
                        }
                    </div>
                    <div class="mt-auto text-right">
                        <span class="text-2xl lg:text-3xl font-bold highlight-blue block">${formatCurrency(
                          amount
                        )}</span>
                        <span class="text-sm text-gray-400 block">占当前总支出 ${percentage}%</span>
                    </div>`;
              el.topShopCategoriesGrid.appendChild(card);
            });
          setupIntersectionObserver(); // Apply animation to new cards
        } else {
          el.shopListNoData.style.display = "block";
          el.topShopCategoriesGrid.style.display = "none";
        }

        // --- Footer Update ---
        el.generationDate.textContent = new Date().toLocaleString("zh-CN");

        // Re-run observer after potentially adding new cards
        setupIntersectionObserver();
      } // --- End of renderReport function ---

      // --- NEW Helper function to calculate unique reporting days ---
      function calculateReportingDays(transactions) {
        if (!transactions || transactions.length === 0) return 0;
        const uniqueDates = new Set(transactions.map((t) => t.dateStr));
        return uniqueDates.size;
      }

      // --- UPDATED Function to Update Item List (Handles Both Category and Daily) ---
      function updateItemList(items, title, listType = "category") {
        // listType can be 'category' or 'daily'
        el.itemListContainer.innerHTML = ""; // Clear previous items
        el.itemListTitle.textContent = title;

        if (!items || items.length === 0) {
          el.itemListNoData.textContent =
            listType === "daily" ? "当天无购物记录。" : "此分类下无商品记录。";
          el.itemListNoData.style.display = "block";
          return;
        }

        el.itemListNoData.style.display = "none";

        // Sort items by price descending
        const sortedItems = [...items].sort(
          (a, b) => b.cny_price - a.cny_price
        );

        sortedItems.forEach((item) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "item-entry"; // Use shared CSS class

          const dateString = item.timestamp
            ? item.timestamp.toLocaleDateString("zh-CN", {
                month: "2-digit",
                day: "2-digit",
              })
            : "N/A";
          const categoryPath = [
            item.category_1,
            item.category_2,
            item.category_3,
          ]
            .filter(Boolean)
            .join(" > ");
          const discountIcon = item.is_special
            ? `<i class="fas fa-tags item-discount-icon" title="折扣商品"></i>`
            : "";

          itemDiv.innerHTML = `
                  <div class="item-details">
                      <span class="item-name" title="${item.chinese_name}">
                          ${item.chinese_name}
                          ${discountIcon}
                       </span>
                      <span class="item-meta">${
                        listType === "daily"
                          ? item.shop_name || "未知商店"
                          : dateString + " / " + (item.shop_name || "未知商店")
                      }</span>
                      <span class="item-meta">${categoryPath}</span>
                  </div>
                  <span class="item-price">${formatCurrency(
                    item.cny_price
                  )}</span>
              `;
          el.itemListContainer.appendChild(itemDiv);
        });

        // Ensure the item list column is the correct width depending on the view
        if (listType === "daily") {
          el.itemListColumn.classList.remove("lg:w-1/2");
          el.itemListColumn.classList.add("lg:w-full");
        } else {
          el.itemListColumn.classList.remove("lg:w-full");
          el.itemListColumn.classList.add("lg:w-1/2");
        }
      }

      // --- UPDATED: Switch to Category View Function ---
      function switchToCategoryView() {
        console.log("Switching to Category View");
        currentViewMode = "category";
        // Show category chart, hide daily list specifics if needed
        el.categoryChartColumn.style.display = "block";
        el.itemListColumn.classList.remove("lg:w-full");
        el.itemListColumn.classList.add("lg:w-1/2");
        // Restore category title and icon
        el.interactiveSectionTitle.querySelector("i").className =
          "fas fa-tags icon-inline text-[#2ECC71]";
        // Update chart and list based on current category level/path
        updateCategoryChart(currentCategoryLevel, currentCategoryPath);
        el.interactiveBackButton.disabled = currentCategoryLevel <= 1; // Re-enable/disable back button based on category level
        el.interactiveBackButton.onclick = handleCategoryBackClick; // Ensure back button has correct handler
      }

      // --- NEW: Switch to Daily Item List View Function ---
      function switchToDailyView(dateStr, items) {
        console.log("Switching to Daily View for date:", dateStr);
        currentViewMode = "daily";
        // Hide category chart, make item list full width
        el.categoryChartColumn.style.display = "none";
        el.itemListColumn.classList.remove("lg:w-1/2");
        el.itemListColumn.classList.add("lg:w-full");
        // Update title and icon for daily view
        el.interactiveSectionTitle.querySelector("i").className =
          "fas fa-calendar-day icon-inline text-[#3498DB]"; // Example: calendar icon
        el.categoryChartTitle.textContent = `${dateStr} 购物列表`; // Update the span inside H2
        // Update the item list
        updateItemList(items, `${dateStr} 购物列表`, "daily");
        el.interactiveBackButton.disabled = false; // Enable back button to return to category view
        el.interactiveBackButton.onclick = resetToCategoryView; // Set back button to reset view
      }

      // --- NEW: Reset view back to the default category display ---
      function resetToCategoryView() {
        if (currentViewMode !== "category") {
          switchToCategoryView();
        } else if (currentCategoryLevel > 1) {
          // If already in category view but drilled down, go back one level
          handleCategoryBackClick();
        }
        // If already at top level category view, the button should be disabled anyway
      }

      // --- Interactive Category Chart Functions ---
      function updateCategoryChart(level, path) {
        // Only proceed if in category view mode
        if (currentViewMode !== "category") {
          console.log("Not in category view, skipping category chart update.");
          return;
        }

        console.log("Updating category chart to level:", level, "path:", path);
        currentCategoryLevel = level;
        currentCategoryPath = path;

        let dataToShow = {};
        let currentLevelData = categoryHierarchyData;
        let parentTotal = globalCurrentTotalSpend;
        let itemsForCurrentView = []; // Define itemsForCurrentView here

        try {
          // Navigate hierarchy for chart data
          for (let i = 0; i < path.length; i++) {
            if (
              !currentLevelData[path[i]] ||
              !currentLevelData[path[i]]._children
            ) {
              throw new Error(
                `Invalid path or data structure at: ${path
                  .slice(0, i + 1)
                  .join(" > ")}`
              );
            }
            parentTotal = currentLevelData[path[i]]._total;
            currentLevelData = currentLevelData[path[i]]._children;
          }

          // Get items for the current level/path for the list view
          let currentItemNode = categoryHierarchyData;
          for (let i = 0; i < path.length; i++) {
            if (!currentItemNode[path[i]]) {
              throw new Error(`Path element ${path[i]} not found for items.`);
            }
            currentItemNode = currentItemNode[path[i]]; // Navigate to the node itself
            if (i < path.length - 1) {
              // If not the last element, go to children for the next iteration
              currentItemNode = currentItemNode._children;
            }
          }
          itemsForCurrentView =
            level === 1
              ? currentFilteredTransactions
              : currentItemNode._items || [];
        } catch (e) {
          console.error("Error navigating hierarchy:", e, "Path:", path);
          // Attempt to gracefully recover or reset
          currentCategoryLevel = 1;
          currentCategoryPath = [];
          currentLevelData = categoryHierarchyData;
          parentTotal = globalCurrentTotalSpend;
          itemsForCurrentView = currentFilteredTransactions; // Show all items on error/reset
        }

        const categories = Object.keys(currentLevelData).filter(
          (key) => !key.startsWith("_")
        );
        dataToShow = categories.reduce((acc, category) => {
          if (
            currentLevelData[category] &&
            typeof currentLevelData[category]._total === "number"
          ) {
            acc[category] = currentLevelData[category]._total;
          }
          return acc;
        }, {});

        const sortedData = Object.entries(dataToShow).sort(
          ([, a], [, b]) => b - a
        );
        const chartLabels = sortedData.map(([category]) => category);
        const chartData = sortedData.map(([, amount]) => amount);
        const currentViewTotal = chartData.reduce((sum, val) => sum + val, 0);

        // Update chart title (span inside H2)
        if (level === 1) {
          el.categoryChartTitle.textContent = "分类支出分析";
        } else {
          el.categoryChartTitle.textContent = `${path.join(
            " > "
          )} (${formatCurrency(currentViewTotal)})`;
        }
        el.interactiveBackButton.disabled = level <= 1; // Only disable if at root level
        el.interactiveBackButton.onclick = handleCategoryBackClick; // Ensure correct handler

        // Update the item list section with items relevant to this category level
        const listTitle =
          level === 1 ? "所有商品列表" : `${path.join(" > ")} 商品列表`;
        updateItemList(itemsForCurrentView, listTitle, "category"); // Use the generic item list function

        // Chart configuration
        const chartConfig = {
          type: "doughnut",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: `支出 (${path.join(" > ") || "总览"})`,
                data: chartData,
                backgroundColor: generateVibrantColors(
                  chartLabels.length,
                  highlightColor
                ),
                borderColor: "#1a1a1a",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "60%",
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: chartTextColor,
                  boxWidth: 12,
                  padding: 15,
                  filter: (item, chartData) => chartData.labels.length <= 15,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || "";
                    if (label) label += ": ";
                    if (context.parsed !== null) {
                      const amount = context.parsed;
                      label += formatCurrency(amount);
                      const percentage =
                        currentViewTotal > 0
                          ? ((amount / currentViewTotal) * 100).toFixed(1)
                          : 0;
                      label += ` (${percentage}%)`;
                    }
                    return label;
                  },
                },
              },
              title: { display: false },
            },
            onClick: handleCategoryChartClick, // Keep drill-down functionality
          },
        };

        // Create or update chart instance
        const ctxCategory = el.categoryChartCanvas.getContext("2d");
        if (categoryChartInstance) {
          categoryChartInstance.destroy();
        }

        if (chartLabels.length === 0) {
          el.categoryChartNoData.style.display = "block";
          el.categoryChartNoData.textContent =
            level === 1 ? "无分类数据可显示。" : "此子分类下无数据。";
          clearCanvas(el.categoryChartCanvas);
          categoryChartInstance = null;
        } else {
          el.categoryChartNoData.style.display = "none";
          categoryChartInstance = new Chart(ctxCategory, chartConfig);
        }
      }

      function handleCategoryChartClick(event) {
        if (currentViewMode !== "category" || !categoryChartInstance) return; // Only works in category mode
        const points = categoryChartInstance.getElementsAtEventForMode(
          event,
          "nearest",
          { intersect: true },
          true
        );

        if (points.length && currentCategoryLevel < 3) {
          // Limit drill-down depth
          const firstPoint = points[0];
          const clickedLabel =
            categoryChartInstance.data.labels[firstPoint.index];
          const newPath = [...currentCategoryPath, clickedLabel];

          // Check if the clicked category has children to drill down into
          let nextLevelData = categoryHierarchyData;
          let hasChildren = false;
          try {
            for (let i = 0; i < newPath.length; i++) {
              nextLevelData = nextLevelData[newPath[i]]._children;
            }
            hasChildren = Object.keys(nextLevelData).some(
              (key) => !key.startsWith("_")
            );
          } catch (e) {
            hasChildren = false; // Error likely means no children or invalid path
          }

          if (hasChildren) {
            console.log("Drilling down to:", newPath);
            updateCategoryChart(currentCategoryLevel + 1, newPath);
          } else {
            console.log("No further drill down available for:", clickedLabel);
            // Optionally, you could display the items for this specific category here
            // by finding the items associated with the clickedLabel at the current path
            let finalNode = categoryHierarchyData;
            try {
              for (const p of currentCategoryPath) {
                finalNode = finalNode[p]._children;
              }
              const clickedNodeItems = finalNode[clickedLabel]._items;
              updateItemList(
                clickedNodeItems,
                `${newPath.join(" > ")} 商品列表`,
                "category"
              );
              // Maybe disable back button here temporarily? Or keep it to go back up.
            } catch (e) {
              console.error(
                "Could not get items for leaf node:",
                clickedLabel,
                e
              );
            }
          }
        }
      }

      function handleCategoryBackClick() {
        if (currentViewMode === "category" && currentCategoryLevel > 1) {
          const newPath = currentCategoryPath.slice(0, -1);
          console.log("Going back in category view to:", newPath);
          updateCategoryChart(currentCategoryLevel - 1, newPath);
        } else {
          // If not in category view or at level 1, this button should reset to category view
          resetToCategoryView();
        }
      }

      // --- NEW: Spending Trend Chart Click Handler ---
      function handleSpendingTrendClick(event) {
        if (!spendingTrendChartInstance) return;
        const points = spendingTrendChartInstance.getElementsAtEventForMode(
          event,
          "nearest",
          { axis: "x", intersect: false },
          true
        );

        if (points.length) {
          const firstPoint = points[0];
          const clickedDateStr =
            spendingTrendChartInstance.data.labels[firstPoint.index]; // Get the 'YYYY-MM-DD' label

          console.log("Trend chart clicked, Date:", clickedDateStr);

          // Filter transactions for the clicked date
          const dailyItems = currentFilteredTransactions.filter(
            (item) => item.dateStr === clickedDateStr
          );

          // Switch the view to show the daily list
          switchToDailyView(clickedDateStr, dailyItems);
        }
      }

      // --- Date Filtering Logic ---
      function applyDateFilter() {
        const startDate = el.startDateInput.value;
        const endDate = el.endDateInput.value;

        console.log(
          `Filtering from ${startDate || "beginning"} to ${endDate || "end"}`
        );

        if (!startDate && !endDate) {
          handleResetFilter(); // Just reset if both are empty
          return;
        }

        const filteredTransactions = originalTransactions.filter((item) => {
          const itemDate = item.dateStr; // Compare using YYYY-MM-DD
          const startMatch = startDate ? itemDate >= startDate : true;
          const endMatch = endDate ? itemDate <= endDate : true;
          return startMatch && endMatch;
        });

        // Sorting should already be done by cleanTransactionData, but doesn't hurt to ensure
        filteredTransactions.sort((a, b) => a.timestamp - b.timestamp);
        renderReport(filteredTransactions);
        // Always reset to category view after filtering
        resetToCategoryView();
      }

      function handleResetFilter() {
        console.log("Resetting filter");
        el.startDateInput.value = "";
        el.endDateInput.value = "";
        el.reportDateRange.textContent = ""; // Clear specific range text
        renderReport(originalTransactions); // Re-render with all original data
        // Always reset to category view after resetting filter
        resetToCategoryView();
      }

      // --- Helper to Clear Canvas ---
      function clearCanvas(canvasElement) {
        if (!canvasElement) return;
        const ctx = canvasElement.getContext("2d");
        ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      }

      // --- Intersection Observer for Animations ---
      function setupIntersectionObserver() {
        const observerOptions = {
          root: null,
          rootMargin: "0px",
          threshold: 0.1,
        };
        const observerCallback = (entries, observer) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        };
        const observer = new IntersectionObserver(
          observerCallback,
          observerOptions
        );
        const targets = document.querySelectorAll(".animate-on-scroll");
        targets.forEach((target) => {
          // Reset animation state if it was previously visible but now part of a re-render
          // target.classList.remove('is-visible');
          // target.style.opacity = 0;
          // target.style.transform = 'translateY(20px)';
          // We only observe if it's NOT already visible
          if (!target.classList.contains("is-visible")) {
            observer.observe(target);
          } else {
            // If it IS visible (e.g. from a previous scroll), ensure styles are correct immediately
            // This prevents elements reappearing with the animation if they were already visible
            target.style.opacity = 1;
            target.style.transform = "translateY(0)";
          }
        });
      }

      // --- Initial Data Load and Setup ---
      async function initializeReport() {
        try {
          el.reportTitle.textContent = "正在加载报告...";
          // Use the actual endpoint that serves your CSV data
          const response = await fetch("/generate_overview_csv"); // Adjust if your endpoint is different
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const csvData = await response.text();

          Papa.parse(csvData, {
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              console.log("Parsed CSV Data:", results.data.length, "items");
              if (results.errors.length > 0) {
                console.error("CSV Parsing Errors:", results.errors);
                // Display a user-friendly error
                el.reportTitle.textContent = "数据解析错误";
                el.reportSubtitle.textContent = "请检查CSV文件格式";
                el.overviewNoData.textContent = `解析错误: ${results.errors
                  .map((e) => e.message)
                  .join("; ")}`;
                el.overviewNoData.style.display = "block";
                el.overviewNoData.classList.add("text-red-500");
                return;
              }

              originalTransactions = cleanTransactionData(results.data);
              console.log(
                "Cleaned Data:",
                originalTransactions.length,
                "items"
              );
              currentFilteredTransactions = originalTransactions; // Initialize filtered list

              if (originalTransactions.length === 0) {
                el.reportTitle.textContent = "无有效数据";
                el.reportSubtitle.textContent = "No valid data available";
                el.reportDateRange.textContent = "未能加载任何有效交易记录";
                el.filterButton.disabled = true;
                el.resetButton.disabled = true;
                renderReport([]); // Render empty state
              } else {
                const firstDate = originalTransactions[0].timestamp;
                // const lastDate = originalTransactions[originalTransactions.length - 1].timestamp;
                // const month = firstDate.toLocaleString('zh-CN', { month: 'long' });
                // const year = firstDate.getFullYear();
                el.reportTitle.textContent = `个人消费分析报告`;
                el.reportSubtitle.textContent = `Personal Consumption Analysis Report`;
                el.filterButton.disabled = false;
                el.resetButton.disabled = false;
                renderReport(originalTransactions); // Initial render with all data
              }
              // Setup animations after initial content structure is set
              setupIntersectionObserver();
            },
            error: function (error) {
              console.error("PapaParse Error:", error);
              el.reportTitle.textContent = "数据加载或解析失败";
              el.reportSubtitle.textContent = error.message;
              el.overviewNoData.textContent = `加载/解析错误: ${error.message}`;
              el.overviewNoData.style.display = "block";
              el.overviewNoData.classList.add("text-red-500");
            },
          });
        } catch (error) {
          console.error("Error fetching or processing data:", error);
          el.reportTitle.textContent = "加载失败";
          el.reportSubtitle.textContent = "无法连接到数据源或处理时出错";
          el.overviewNoData.textContent = `加载失败: ${error.message}. 请确保后端服务可用。`;
          el.overviewNoData.style.display = "block";
          el.overviewNoData.classList.add("text-red-500");
        }
      }

      // --- Event Listeners ---
      document.addEventListener("DOMContentLoaded", () => {
        initializeReport();
        // Use the renamed back button ID and the reset function
        el.interactiveBackButton.addEventListener("click", resetToCategoryView);
        el.filterButton.addEventListener("click", applyDateFilter);
        el.resetButton.addEventListener("click", handleResetFilter);
        el.startDateInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") applyDateFilter();
        });
        el.endDateInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") applyDateFilter();
        });

        // Add listener for the interactive back button (handles both category back and daily list back)
        el.interactiveBackButton.addEventListener("click", () => {
          if (currentViewMode === "daily") {
            resetToCategoryView(); // If showing daily list, go back to category view
          } else if (currentViewMode === "category") {
            handleCategoryBackClick(); // If showing categories, perform normal category back
          }
        });
      });
    </script>
  </body>
</html>
