# 时区功能实现总结

## 概述
系统已全面实现用户时区支持，解决了数据库使用UTC时区而用户界面需要显示本地时区的问题。

## 实现的功能

### 1. 配置层面
- **配置文件支持**: 在 `config.py` 中添加了 `user_timezone` 配置项，默认为 `Asia/Shanghai`
- **动态配置**: 用户可以通过设置页面修改时区配置
- **配置持久化**: 时区设置保存在 `settings.json` 文件中

### 2. 后端时区转换
- **convert_local_to_utc()**: 将用户本地时间转换为UTC时间存储到数据库
- **convert_utc_to_local()**: 将数据库中的UTC时间转换为用户本地时间
- **get_user_timezone()**: 获取用户设置的时区

### 3. 数据序列化层
- **UserTimezoneDateTime**: 自定义Marshmallow字段，自动将UTC时间转换为用户本地时间
- **Schema更新**: Receipt、Item、ExportRecord等Schema都使用了时区感知的时间字段

### 4. API层面
- **设置API**: 新增 `/api/settings/timezone` 接口用于保存时区设置
- **日期筛选修复**: 所有涉及日期筛选的API都已修复，将前端传入的本地时间转换为UTC时间进行数据库查询

### 5. 前端界面
- **设置页面**: 添加了时区选择界面，支持常用时区选择
- **实时预览**: 显示当前选择时区的本地时间
- **localStorage同步**: 时区设置保存到浏览器本地存储，供前端时间格式化使用

### 6. 前端时间处理
- **formatDateToLocal()**: 更新为支持用户设置的时区
- **自动转换**: 页面上的时间戳会根据用户时区自动转换显示

## 修复的功能

### 1. 数据筛选功能
修复了以下服务中的时间筛选逻辑：
- **ReceiptService.get_export_records()**: 小票导出时间筛选
- **AnalyticsService.get_dashboard_overview()**: 仪表盘数据时间筛选
- **AnalyticsService.get_spending_trend()**: 消费趋势时间筛选
- **AnalyticsService.get_daily_items()**: 每日商品查询
- **AnalyticsService.get_category_analysis()**: 分类分析时间筛选
- **AnalyticsService.get_category_items()**: 分类商品时间筛选
- **DataMiningService.get_category_tree()**: 分类树时间筛选
- **DataMiningService.get_categories_comparison_data()**: 分类对比时间筛选

### 2. 时间显示功能
- **小票列表**: 创建时间、交易时间按用户时区显示
- **商品列表**: 商品时间戳按用户时区显示
- **分析页面**: 图表和统计数据的时间按用户时区显示
- **数据挖掘**: 所有时间相关的展示按用户时区显示

## 支持的时区

### 亚洲
- 中国标准时间 (UTC+8) - 上海
- 香港时间 (UTC+8) - 香港
- 台北时间 (UTC+8) - 台北
- 日本标准时间 (UTC+9) - 东京
- 韩国标准时间 (UTC+9) - 首尔
- 新加坡时间 (UTC+8) - 新加坡
- 泰国时间 (UTC+7) - 曼谷
- 马来西亚时间 (UTC+8) - 吉隆坡

### 欧洲
- 英国时间 (UTC+0/+1) - 伦敦
- 中欧时间 (UTC+1/+2) - 巴黎、柏林、罗马
- 莫斯科时间 (UTC+3) - 莫斯科

### 美洲
- 美国东部时间 (UTC-5/-4) - 纽约
- 美国中部时间 (UTC-6/-5) - 芝加哥
- 美国山地时间 (UTC-7/-6) - 丹佛
- 美国太平洋时间 (UTC-8/-7) - 洛杉矶
- 加拿大东部时间 (UTC-5/-4) - 多伦多

### 大洋洲
- 澳大利亚东部时间 (UTC+10/+11) - 悉尼、墨尔本
- 新西兰时间 (UTC+12/+13) - 奥克兰

### 其他
- 协调世界时 (UTC+0)

## 技术实现细节

### 数据流
1. **数据存储**: 数据库中所有时间字段存储为UTC时间
2. **API输入**: 前端传入的时间（筛选条件等）为用户本地时间，后端转换为UTC后查询
3. **API输出**: 数据库查询结果通过Schema自动转换为用户本地时间
4. **前端显示**: 使用用户设置的时区进行时间格式化

### 关键组件
- **pytz**: Python时区处理库
- **Marshmallow**: 数据序列化，自动时区转换
- **localStorage**: 前端时区设置存储
- **Intl.DateTimeFormat**: 前端时区格式化

## 使用方式

### 用户操作
1. 进入"系统设定"页面
2. 在"时区设定"卡片中选择所在时区
3. 点击"保存时区设定"
4. 系统会自动应用新的时区设置到所有时间显示和筛选功能

### 开发者说明
- 所有新增的时间筛选功能都应使用 `convert_local_to_utc()` 转换前端传入的时间
- 所有返回给前端的时间字段都应使用 `UserTimezoneDateTime` 字段类型
- 前端时间格式化应使用 `formatDateToLocal()` 函数

## 依赖更新
- 新增依赖: `pytz` (Python时区处理库)

## 测试验证
- 创建了 `test_timezone.py` 测试脚本
- 验证了时区转换函数的正确性
- 测试了配置保存和加载功能
- 确认了往返转换的一致性

## 注意事项
1. 数据库中的历史数据时间格式保持不变（UTC时间）
2. 时区更改只影响显示和新的数据筛选，不影响已存储的数据
3. 建议在初次使用时设置正确的时区以确保最佳体验
4. 夏令时变化由pytz库自动处理

## 兼容性
- 兼容所有现有功能
- 向后兼容，不影响现有数据
- 支持主流浏览器的时区功能
